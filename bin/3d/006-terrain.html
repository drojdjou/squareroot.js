<!DOCTYPE html>
<html>
<head>
    <title>Terrain | v0.30</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable = no">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    <script type="text/javascript" src="../../lib/Stats.js"></script>

<!-- SQRLIB -->
<!-- Auto-generated by tools/demojstags.py. Do not edit this section -->
<script type="text/javascript" src="../../src/requestAnimFrame.js"></script>
<script type="text/javascript" src="../../src/SQR.js"></script>
<script type="text/javascript" src="../../src/sqr/Squareroot.js"></script>
<script type="text/javascript" src="../../src/sqr/SquarerootGL.js"></script>
<script type="text/javascript" src="../../src/sqr/Transform.js"></script>
<script type="text/javascript" src="../../src/sqr/geometry/Cube.js"></script>
<script type="text/javascript" src="../../src/sqr/geometry/Plane.js"></script>
<script type="text/javascript" src="../../src/sqr/geometry/Sprite2D.js"></script>
<script type="text/javascript" src="../../src/sqr/geometry/Sprite3D.js"></script>
<script type="text/javascript" src="../../src/sqr/geometry/Triangle.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Interpolation.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Mathx.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Matrix2D.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Matrix33.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Matrix44.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Noise.js"></script>
<script type="text/javascript" src="../../src/sqr/math/PerlinNoise.js"></script>
<script type="text/javascript" src="../../src/sqr/math/ProjectionMatrix.js"></script>
<script type="text/javascript" src="../../src/sqr/math/QuadraticBezier.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Quaternion.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Spline.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Spring.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Vector2.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Vector3.js"></script>
<script type="text/javascript" src="../../src/sqr/math/VectorUtil.js"></script>
<script type="text/javascript" src="../../src/sqr/physics/CSSCollider.js"></script>
<script type="text/javascript" src="../../src/sqr/physics/Particle.js"></script>
<script type="text/javascript" src="../../src/sqr/renderers/DOMElement2D.js"></script>
<script type="text/javascript" src="../../src/sqr/renderers/DOMElement3D.js"></script>
<script type="text/javascript" src="../../src/sqr/renderers/Point.js"></script>
<script type="text/javascript" src="../../src/sqr/renderers/Polygon.js"></script>
<script type="text/javascript" src="../../src/sqr/renderers/Segment.js"></script>
<script type="text/javascript" src="../../src/sqr/renderers/WebGL.js"></script>
<script type="text/javascript" src="../../src/sqr/util/CanvasUtil.js"></script>
<script type="text/javascript" src="../../src/sqr/util/Color.js"></script>
<script type="text/javascript" src="../../src/sqr/util/DOMUtil.js"></script>
<script type="text/javascript" src="../../src/sqr/util/GL.js"></script>
<script type="text/javascript" src="../../src/sqr/util/Interactor.js"></script>
<script type="text/javascript" src="../../src/sqr/util/Loader.js"></script>
<script type="text/javascript" src="../../src/sqr/util/Shader.js"></script>
<script type="text/javascript" src="../../src/sqr/util/Stringify.js"></script>
<script type="text/javascript" src="../../src/sqr/util/Time.js"></script>
<!-- SQRLIB -->

    <style type="text/css">

        body {
            overflow: hidden;
        }

        #canvas {
            position: absolute;
            top: 0px;
            left: 0px;
        }

        #hm-container {
            position: absolute;
            top: 0px;
            left: 0px;
        }

    </style>

    <script type="text/javascript">

        var engine, camera, geometry, renderer, terrain;
        var hmc, hctx, hdata;
        var zero = new SQR.V3();
        var mx = 0, my = 0;
        var stats;

        SQR.Plane.prototype.applyHeightMap = function(heightMap, maxHeight, offset, range) {

            var numTriangles = this.polygons.length;

            var w = this.width * 0.5;
            var h = this.height * 0.5;
     
            var processVertex = function(t) {
                var row = (t.z / h + 1) / 2;
                var col = (t.x / w + 1) / 2;

                row = (offset + row * range) % 1;

                var hl = SQR.CanvasUtil.getPixelNormRed(heightMap, col, row) / 255 * maxHeight;
                t.y = maxHeight - hl;
            }

            for (var i = 0; i < numTriangles; i++) {
                var t = this.polygons[i];
                processVertex(t.a);
                processVertex(t.b);
                processVertex(t.c);
            }
        }

        window.onload = function() {
            
           stats = new Stats();
           stats.setMode(0);
           stats.domElement.style.position = 'absolute';
           stats.domElement.style.left = '0px';
           stats.domElement.style.top = '0px';
           document.body.appendChild(stats.domElement);

            document.addEventListener('touchmove', function(e) {
                e.preventDefault();
            }, false);

            document.addEventListener('mousemove', function(e) {
                mx = e.pageX / window.innerWidth;
            }, false);

            engine = new SQR.Squareroot(document.getElementById('canvas'), document.getElementById("div-container"));
            engine.setBackground("#000000");
            engine.setSize(window.innerWidth, window.innerHeight);
            engine.setProjection(45);
            engine.setClearColor("rgba(0,0,0,1)");

            terrain = new SQR.Transform();

            terrain.renderer = new SQR.Polygon();
            terrain.renderer.useLight = true;

            var c = new SQR.Color(0, 100, 70);
            terrain.geometry = new SQR.Plane(100, 100, 12, 12, 0, 0, true, c);

            camera = new SQR.Transform();
            camera.position.z = 140;
            camera.position.y = -140;

            camera.rotation.x = 0.9;
//            camera.lookInDirection(terrain.position);

            engine.add(camera, terrain);

            hmc = document.createElement('canvas');
//            document.getElementById('hm-container').appendChild(hmc);
            hctx = hmc.getContext('2d');

            var hmimage = new Image();
            hmimage.onload = function() {

                hmc.width = hmimage.width;
                hmc.height = hmimage.height;

                hctx.drawImage(hmimage, 0, 0);
                hdata = hctx.getImageData(0, 0, hmc.width, hmc.height);

                render();
            }

            hmimage.src = '../assets/terrain-heightmap.jpg';
        }

        function v(x, y, z) {
            return new SQR.V3(x, y, z);
        }

        var th = 0;
        var a = 0;

        function render() {
            stats.begin();

            requestAnimFrame(render);
            
            if(th++ % 2 == 1) {
                //stats.end();
                //return;
            };

            terrain.rotation.y += 0.002;

            terrain.geometry.applyHeightMap(hdata, 40, a, 0.1);
            a += 0.06 * SQR.Time.deltaTime;

            engine.render(camera);

            stats.end();
        }

    </script>

</head>
<body>
<div id="canvas-container">
    <canvas id="canvas"></canvas>
</div>
<div id="div-container"></div>

<div id="hm-container"></div>
</body>
</html>