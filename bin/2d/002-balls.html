<!DOCTYPE html>
<html>
<head>
    <title>A few bouncing balls | v0.12</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable = no">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    <style type="text/css">

        body {
            background-color: #000000;
            overflow: hidden;
        }

        #cnv {
            position: absolute;
            top: 0px;
            left: 0px;
            background-color: #000000;
        }

        #debug {
            position: absolute;
            top: 10px;
            left: 10px;
            font-family: monospace;
            color: #ffffff;
            font-size: 14px;
        }

    </style>

<!-- SQRLIB -->
<!-- Auto-generated by tools/demojstags.py. Do not edit this section -->
<script type="text/javascript" src="../../src/requestAnimFrame.js"></script>
<script type="text/javascript" src="../../src/SQR.js"></script>
<script type="text/javascript" src="../../src/sqr/Squareroot.js"></script>
<script type="text/javascript" src="../../src/sqr/SquarerootGL.js"></script>
<script type="text/javascript" src="../../src/sqr/Transform.js"></script>
<script type="text/javascript" src="../../src/sqr/geometry/Cube.js"></script>
<script type="text/javascript" src="../../src/sqr/geometry/Cylinder.js"></script>
<script type="text/javascript" src="../../src/sqr/geometry/Geometry.js"></script>
<script type="text/javascript" src="../../src/sqr/geometry/Icosphere.js"></script>
<script type="text/javascript" src="../../src/sqr/geometry/Mesh.js"></script>
<script type="text/javascript" src="../../src/sqr/geometry/Plane.js"></script>
<script type="text/javascript" src="../../src/sqr/geometry/Pyramid.js"></script>
<script type="text/javascript" src="../../src/sqr/geometry/Quad.js"></script>
<script type="text/javascript" src="../../src/sqr/geometry/Sprite2D.js"></script>
<script type="text/javascript" src="../../src/sqr/geometry/Sprite3D.js"></script>
<script type="text/javascript" src="../../src/sqr/geometry/Triangle.js"></script>
<script type="text/javascript" src="../../src/sqr/geometry/Tube.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Interpolation.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Mathx.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Matrix2D.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Matrix33.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Matrix44.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Noise.js"></script>
<script type="text/javascript" src="../../src/sqr/math/PerlinNoise.js"></script>
<script type="text/javascript" src="../../src/sqr/math/ProjectionMatrix.js"></script>
<script type="text/javascript" src="../../src/sqr/math/QuadraticBezier.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Quaternion.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Spline.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Spring.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Vector2.js"></script>
<script type="text/javascript" src="../../src/sqr/math/Vector3.js"></script>
<script type="text/javascript" src="../../src/sqr/math/VectorUtil.js"></script>
<script type="text/javascript" src="../../src/sqr/physics/CSSCollider.js"></script>
<script type="text/javascript" src="../../src/sqr/physics/Particle.js"></script>
<script type="text/javascript" src="../../src/sqr/renderers/DOMElement2D.js"></script>
<script type="text/javascript" src="../../src/sqr/renderers/DOMElement3D.js"></script>
<script type="text/javascript" src="../../src/sqr/renderers/Point.js"></script>
<script type="text/javascript" src="../../src/sqr/renderers/Polygon.js"></script>
<script type="text/javascript" src="../../src/sqr/renderers/Segment.js"></script>
<script type="text/javascript" src="../../src/sqr/renderers/WebGL.js"></script>
<script type="text/javascript" src="../../src/sqr/util/CanvasUtil.js"></script>
<script type="text/javascript" src="../../src/sqr/util/Color.js"></script>
<script type="text/javascript" src="../../src/sqr/util/Cubemap.js"></script>
<script type="text/javascript" src="../../src/sqr/util/DOMUtil.js"></script>
<script type="text/javascript" src="../../src/sqr/util/FrameBuffer.js"></script>
<script type="text/javascript" src="../../src/sqr/util/GL.js"></script>
<script type="text/javascript" src="../../src/sqr/util/Interactor.js"></script>
<script type="text/javascript" src="../../src/sqr/util/Loader.js"></script>
<script type="text/javascript" src="../../src/sqr/util/OBJParser.js"></script>
<script type="text/javascript" src="../../src/sqr/util/PostEffect.js"></script>
<script type="text/javascript" src="../../src/sqr/util/RenderRegion.js"></script>
<script type="text/javascript" src="../../src/sqr/util/Shader.js"></script>
<script type="text/javascript" src="../../src/sqr/util/Stringify.js"></script>
<script type="text/javascript" src="../../src/sqr/util/Texture.js"></script>
<script type="text/javascript" src="../../src/sqr/util/Time.js"></script>
<!-- SQRLIB -->

    <script type="text/javascript">

        var ctx;

        var gravityDirection = Math.PI * 0.5;
        var gravity = new SQR.V2(
            9.81 * Math.cos(gravityDirection),
            9.81 * Math.sin(gravityDirection)
        );

        var gravityScaled = new SQR.V2();

        var balls = [];
        var numBalls = (window.innerWidth > 320) ? 40 : 20;
        console.log(numBalls);
        var gravityOn = true;

        var throttle = 0;
        var debugDiv;
        var gx = 0, gy = 0, gz = 0, acc;

        window.onload = function() {

            var cnv = document.getElementById('cnv');
            debugDiv = document.querySelector("#debug");

            ctx = cnv.getContext('2d');

            document.addEventListener('click', function(e) {

                for (var i = 0; i < balls.length; i++) {
                    var b = balls[i];
                    var fx = Math.random() * 1600 - 800;
                    var fy = -800;
                    balls[i].addForce(new SQR.V2(fx * b.mass, fy * b.mass));
                }

            }, false);

            document.addEventListener('touchstart', function(e) {
                e.preventDefault();
            }, false);

            document.addEventListener('touchstart', function(e) {

                for (var i = 0; i < balls.length; i++) {
                    var b = balls[i];
                    var fx = Math.random() * 1600 - 800;
                    var fy = -800;
                    balls[i].addForce(new SQR.V2(fx * b.mass, fy * b.mass));
                }

            }, false);

            document.addEventListener('keydown', function(e) {
                if (e.keyCode == 32) gravityOn = !gravityOn;
            }, false);

            var _tmp = new SQR.V2();

            SQR.Particle.prototype.draw = function(ctx) {

                if (this.position.x + this.radius > window.innerWidth) {
                    this.position.x = window.innerWidth - this.radius;
                    this.velocity.x *= -this.bounciness;
                }

                if (this.position.x - this.radius < 0) {
                    this.position.x = this.radius;
                    this.velocity.x *= -this.bounciness;
                }

                if (this.position.y + this.radius > window.innerHeight) {
                    this.position.y = window.innerHeight - this.radius;
                    this.velocity.y *= -this.bounciness;
                }

                if (this.position.y - this.radius < 0) {
                    this.position.y = this.radius;
                    this.velocity.y *= -this.bounciness;
                }

                ctx.fillStyle = 'rgba(255,0,0, 0.5)';
                ctx.beginPath();
                ctx.arc(this.position.x, this.position.y, this.radius, 0, SQR.twoPI);
                ctx.stroke();
                ctx.fill();

                ctx.fillStyle = 'rgba(255,0,0, 0.5)';
                ctx.beginPath();
                ctx.arc(this.position.x, this.position.y, Math.max(2, this.radius - 10), 0, SQR.twoPI);
                ctx.stroke();
                ctx.fill();
            }

            cnv.width = window.innerWidth;
            cnv.height = window.innerHeight;

            for (var i = 0; i < numBalls; i++) {

                var r = Math.random();

                var b = new SQR.Particle(new SQR.V2(window.innerWidth * Math.random(), 20));

                var rc = Math.min(20, window.innerWidth * 0.02);
                var rv = Math.min(30, window.innerWidth * 0.06);
                b.radius = rc + r * rv;

                b.mass = Math.pow((1 + r) * 5, 4);
                b.bounciness = Math.max(0, 0.75 + r * 0.1);
                b.frictionAir = 1;
                b.frictionGround = 20;
                b.addForce(new SQR.V2(Math.random() * 20 - 10, 0));

                b.position.set(
                    Math.random() * window.innerWidth, 
                    Math.random() * window.innerHeight
                );

                balls.push(b);
            }

            draw();

        }

        window.ondevicemotion = function (e) {
            gx = e.accelerationIncludingGravity.x;
            gy = e.accelerationIncludingGravity.y;
            gz = e.accelerationIncludingGravity.z;

            acc = !(gx == 0 && gy == 0 && gz == 0);
        }

        function draw() {
            requestAnimFrame(draw);

            var isOdd = (++throttle % 2 == 1);

            // debugDiv.innerHTML = gx + "<br>" + gy + "<br>" + gz;
            // debugDiv.innerHTML = gravity.x + " : " + gravity.y;
            //if(isOdd) return;

            ctx.clearRect(0, 0, window.innerWidth, window.innerHeight);
            SQR.Time.tick();

            for (var i = 0; i < numBalls; i++) {
                var b = balls[i];
                b.friction = (b.position >= window.innerHeight - b.radius - 0.1) ? b.frictionAir : b.frictionGround;

                if(acc) gravity.set(gx, -gy);

                if (gravityOn) {
                    gravityScaled.copyFrom(gravity).mul(b.mass);
                    b.addForce(gravityScaled);
                }
                b.update( Math.min(SQR.Time.deltaTime, 1) );
                b.draw(ctx);
            }

            var _tmp = new SQR.V2();

            for (var i = 0; i < numBalls; i++) {
                for (var j = i + 1; j < numBalls; j++) {
                    var b1 = balls[i];
                    var b2 = balls[j];

                    _tmp.sub(b1.position, b2.position);

                    var coldist = b1.radius + b2.radius;
                    coldist = coldist * coldist;

                    var dist = _tmp.magsq();
                    var vl;

                    if(dist <= coldist) {
                        _tmp.sub(b2.position, b1.position);

                        vl = b1.velocity.mag();
                        _tmp.copyTo(b1.velocity);
                        b1.velocity.norm();
                        b1.velocity.mul(vl);
                        b1.velocity.mul(-b1.bounciness);

                        _tmp.sub(b1.position, b2.position);

                        vl = b2.velocity.mag();
                        _tmp.copyTo(b2.velocity);
                        b2.velocity.norm();
                        b2.velocity.mul(vl);
                        b2.velocity.mul(-b2.bounciness);
                    }
                }
            }
        }

    </script>

</head>
<body>
<div id="container">
    <canvas id="cnv"></canvas>
</div>

<div id="debug"></div>
</body>
</html>

















