var SQR={TWOPI:2*Math.PI,HALFPI:.5*Math.PI,EPSILON:1e-6,gl:null,flipMatrix:!0,fullScreenQuad:null,shaderPath:".",Primitives:{V2:function(t,r){return new SQR.V2(t,r)},V3:function(t,r,e){return new SQR.V3(t,r,e)},Q:function(t,r,e,n){return new SQR.Quaternion(t,r,e,n)},M4:function(){return new SQR.Matrix44},F:function(t){var r=function(t,e,n,i){var a=SQR.Face().v(t,e,n,i);return r.faces.push(a),a};return r.faces=[],r.toBuffer=function(e){var n=0;return r.faces.forEach(function(r){t&&t.reverseNormals&&r.flip(),r.calculateNormal(),n+=r.toBuffer(e,n,t&&t.perVertexNormal)}),n},r}},v2:function(){return{aPosition:2}},v3:function(){return{aPosition:3}},v2u2:function(){return{aPosition:2,aUV:2}},v2c3:function(){return{aPosition:2,aColor:3}},v3n3:function(){return{aPosition:3,aNormal:3}},v3n3u2:function(){return{aPosition:3,aNormal:3,aUV:2}},WARN_UNIFORM_NOT_PRESENT:!1};SQR.Version={version:"3.0",build:215,date:"Oct 19th 2017"},SQR.GLSL={diffspec:"/*#docs*/\n//#vertex\nprecision mediump float;\nattribute vec3 aNormal;\nattribute vec3 aPosition;\nattribute vec2 aUV;\nuniform mat4 uMatrix;\nuniform mat4 uViewMatrix;\nuniform mat4 uProjection;\nuniform mat3 uNormalMatrix;\nuniform vec3 uEyePosition;\nvarying vec3 vNormal;\nvarying vec3 vIncident;\nvarying vec2 vUV;\nvoid main() {\n\tvNormal = uNormalMatrix * aNormal;\n\tvec3 p = (uMatrix * vec4(aPosition, 1.0)).xyz;\n\tvIncident = normalize(p - uEyePosition);\n\tvUV = aUV;\n\tgl_Position = uProjection * uViewMatrix * vec4(aPosition, 1.0);\n}\n//#fragment\nprecision mediump float;\n//#include standardLight\nuniform vec3 uAmbient;\nuniform vec3 uColor;\nuniform float uEmissive;\nuniform vec3 uLightDirection;\n#ifdef USE_DIFFUSE_MAP\nuniform sampler2D uTexture;\nuniform vec4 uTextureTileOffset;\n#endif\n#ifdef USE_SPECULAR\nuniform vec4 uSpecularColor;\nuniform float uShininess;\n#endif\n#ifdef USE_SPECULAR_MAP\nuniform sampler2D uSpecularMap;\n#endif\nvarying vec3 vNormal;\nvarying vec3 vIncident;\nvarying vec2 vUV;\nvec4 texture(sampler2D t, vec2 uv) {\n\treturn texture2D(t, uv * uTextureTileOffset.xy + uTextureTileOffset.zw);\n}\nvoid main() {\n\t#ifdef USE_DIFFUSE_MAP\n\tvec3 dm = uColor * texture(uTexture, vUV).rgb;\n\t#else\n\tvec3 dm = uColor;\n\t#endif\n\tvec3 e = dm * uEmissive;\n\tvec3 d = diffuse(vNormal, uLightDirection, dm, 1.0);\n\t#ifdef USE_SPECULAR_MAP\n\t#define SI uSpecularColor.a * texture(uSpecularMap, vUV).r\n\t#else\n\t#define SI uSpecularColor.a\n\t#endif\n\t#ifdef USE_SPECULAR\n\t#define SP specular(vNormal, vIncident, uLightDirection, uSpecularColor.rgb, uShininess, SI)\n\t#else \n\t#define SP vec3(0.0) \n\t#endif\n\tgl_FragColor = vec4(uAmbient + e + d + SP, 1.0);\n}\n",normal2color:"/*#docs*/\n//#vertex indicates that this is where the vertex shader starts\n//#fragment indicates that this is where the fragment shader starts\n//#vertex\nattribute vec3 aPosition;\nattribute vec3 aNormal;\nuniform mat4 uMatrix;\nuniform mat4 uViewMatrix;\nuniform mat4 uProjection;\nuniform mat3 uNormalMatrix;\nvarying vec3 vNormal;\nvoid main() {\n\tvNormal = normalize(uNormalMatrix * aNormal);\n\tgl_Position = uProjection * uViewMatrix * vec4(aPosition, 1.0);\n}\n//#fragment\nprecision mediump float;\nvarying vec3 vNormal;\nvoid main() {\n\tgl_FragColor = vec4(vec3(0.5) + vNormal * 0.5, 1.0);\n}\n",standardLight:"/*#docs*/\nvec3 diffuse(vec3 n, vec3 l, vec3 c, float i) {\n\t#ifdef HEMISPHERE_DIFFUSE\n\treturn (dot(-l, n) * 0.5 + 0.5) * c * i;\n\t#else\n\treturn max(0.0, dot(-l, n)) * c * i;\n\t#endif\n}\nvec3 specular(vec3 n, vec3 v, vec3 l, vec3 c, float sh, float i) {\n\treturn pow(max(0.0, dot(reflect(-l, n), v)), sh) * c.rgb * i;\n}\nfloat brightness(vec3 c) {\n\treturn c.r * 0.2126 + c.g * 0.7152 + c.b * 0.0722;\n}\n",texture:"/*#docs*/\nattribute vec3 aPosition;\nattribute vec2 aUV;\nuniform mat4 uMatrix;\nuniform mat4 uViewMatrix;\nuniform mat4 uProjection;\nuniform mat3 uNormalMatrix;\nvarying vec2 vUV;\nvoid main() {\n\tvUV = aUV;\n\tgl_Position = uProjection * uViewMatrix * vec4(aPosition, 1.0);\n}\n//#fragment\nprecision mediump float;\nuniform sampler2D uTexture;\nvarying vec2 vUV;\nvoid main() {\n\tgl_FragColor = texture2D(uTexture, vUV);\n}\n"},SQR.Animation=function(t){var r=[],e=0,n={duration:t};return n.addClip=function(t){r.push(t),e=r.length},n.play=function(){for(var t=0;t<e;t++)r[t].playing=!0},n.reverse=function(t){for(var n=0;n<e;n++)r[n].reverse=t},n.pause=function(){for(var t=0;t<e;t++)r[t].playing=!1},n.gotoTime=function(t){for(var n=0;n<e;n++)r[n].gotoTime(t)},n.setTimeScale=function(t){for(var n=0;n<e;n++)r[n].timeScale=t},n},SQR.Buffer=function(){var t,r,e,n,i={},a=!1;return i.mode=SQR.gl.TRIANGLES,i.drawMode=SQR.gl.STATIC_DRAW,i.setMode=function(t){return i.mode=t,i},i.layout=function(r,e){i.size=e,i.strideSize=0,i.layout=r,i.attributes={};for(var n in r){var a={offset:i.strideSize,byteOffset:4*i.strideSize,size:r[n]};i.strideSize+=r[n],i.attributes[n]=a}return i.strideByteSize=4*i.strideSize,t=new Float32Array(e*i.strideSize),i},i.resize=function(r,e){i.size=r;var n=new Float32Array(r*i.strideSize);if(e)for(var a=0;a<t.length;a++){var o=a-e*i.strideSize;o>=0&&(n[o]=t[a])}else n.set(t);t=n},i.data=function(r,e){e instanceof Array||(e=Array.prototype.slice.call(arguments,1));for(var n=i.attributes[r],a=e.length/n.size,o=0;o<a;o++)for(var s=0;s<n.size;s++)t[o*i.strideSize+s+n.offset]=e[o*n.size+s];return i},i.set=function(r,e,n){n.toArray?n=n.toArray():n instanceof Array||(n=Array.prototype.slice.call(arguments,2));var a=r?i.attributes[r].offset:0;e<0&&(e+=i.size),e>=i.size&&(e%=i.size);for(var o=0,s=n.length;o<s;o++)t[e*i.strideSize+o+a]=n[o];return i},i.iterate=function(r,e){var n=i.attributes[r];if(r&&!n)throw"> SQR.Buffer.iterate > no such attribute: "+r;for(var a=r?n.offset:0,o=0,s=0;s<t.length;s+=i.strideSize)e(s+a,t,o),o++;return i},i.bind=function(){return SQR.gl.bindBuffer(SQR.gl.ARRAY_BUFFER,e),a&&SQR.gl.bindBuffer(SQR.gl.ELEMENT_ARRAY_BUFFER,n),i},i.update=function(){var o=SQR.gl;return e=e||o.createBuffer(),o.bindBuffer(o.ARRAY_BUFFER,e),o.bufferData(o.ARRAY_BUFFER,t,i.drawMode),a&&(n=o.createBuffer(),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,n),o.bufferData(o.ELEMENT_ARRAY_BUFFER,r,i.drawMode)),i},i.index=function(t){return t instanceof Array||(t=Array.prototype.slice.call(arguments,0)),r=new Uint16Array(t),i.indexSize=t.length,a=!0,i},i.isIndexed=function(){return a},i.draw=function(t){var r=SQR.gl;a?r.drawElements(t.drawMode||i.mode,i.indexSize,r.UNSIGNED_SHORT,0):r.drawArrays(t.drawMode||i.mode,0,i.size)},i.setRawData=function(r,e){t.set(r,e)},i.getDataArray=function(){return t},i.getIndexArray=function(){return r},i.destroy=function(){t.length=0,SQR.gl.deleteBuffer(e),a&&(r.length=0,SQR.gl.deleteBuffer(n))},i},SQR.Clip=function(t){var r={timeScale:1,duration:t,reverse:!1,playing:!1},e=0,n=[],i=0,a=new SQR.V3,o=function(t,r,e){switch(r){case"px":t.position.x=e;break;case"py":t.position.y=e;break;case"pz":t.position.z=e;break;case"rx":t.quaternion.x=e;break;case"ry":t.quaternion.y=e;break;case"rz":t.quaternion.z=e;break;case"rw":t.quaternion.w=e;break;default:console.warn("Unknown animation property: ",r," on ",t)}};return r.addProperty=function(t,e){var a={prop:t,keys:e};return a.size=a.keys.length,n.push(a),i=n.length,r},r.gotoTime=function(t){e=Math.max(t,0),e=Math.min(t,r.duration)},r.update=function(s,u,c){if(r.playing&&0!=i){var l=c/1e3*r.timeScale;e+=r.reverse?-l:l,e<0&&(e+=t),e%=t;for(var f=0;f<i;f++)for(var l=n[f],h=0;h<l.size;h++){var d=l.keys[h+0],v=l.keys[h+1];if(d instanceof SQR.V2){if(e>=d.x&&e<v.x){var m=(e-d.x)/(v.x-d.x),p=d.y+(v.y-d.y)*m;o(s,l.prop,p);break}}else if(d instanceof SQR.Bezier){var R=e;if(R>=d.p0.x&&R<d.p1.x){var m=(R-d.p0.x)/(d.p1.x-d.p0.x);d.valueAt(m,a),o(s,l.prop,a.y);break}}}}},r},SQR.Collider=function(t){var r=this;this.center=new SQR.V3,this.type=t,this.radius,this.box,this.buffer,this.hit=!1,this.calculateBoundingBox=function(){var t=Number.MAX_VALUE,e={minX:t,maxX:-t,minY:t,maxY:-t,minZ:t,maxZ:-t};return r.buffer.iterate("aPosition",function(t,r,n){e.minX=Math.min(e.minX,r[t+0]),e.maxX=Math.max(e.maxX,r[t+0]),e.minY=Math.min(e.minY,r[t+1]),e.maxY=Math.max(e.maxY,r[t+1]),e.minZ=Math.min(e.minZ,r[t+2]),e.maxZ=Math.max(e.maxZ,r[t+2])}),e}},SQR.Collider.SPHERE=1,SQR.Collider.BOX=2,SQR.Collider.MESH=3,SQR.Collider.Sphere=function(t,r){var e=new SQR.Collider(SQR.Collider.SPHERE);return e.radius=t||0,r&&e.center.copyFrom(r),e},SQR.Collider.Box=function(t){var r=new SQR.Collider(SQR.Collider.BOX);return r.box=t,r},SQR.Collider.Mesh=function(t){var r=new SQR.Collider(SQR.Collider.MESH);return r.buffer=t,r.box=r.calculateBoundingBox(),r},SQR.Context=function(t,r,e){!SQR._versionDisplayed&&SQR.Version&&(console.log("%cSquareroot v"+SQR.Version.version+" b"+SQR.Version.build,"background: #663399; color: #dd99ff; padding: 4px 10px 4px 10px"),SQR._versionDisplayed=!0);if(t||(t=document.createElement("canvas")),t instanceof HTMLElement||(t=document.querySelector(t)),!t.getContext)throw"> SQR.Context - Invalid canvas reference.";var n,i={canvas:t};return i.create=function(r,e){e=e||function(){throw"> SQR.Context - Webgl is not supported."},r=r||{},void 0===r.antialias&&(r.antialias=!0),void 0===r.stencil&&(r.stencil=!1),window.WebGLRenderingContext||e();try{n=t.getContext("webgl",r)||t.getContext("experimental-webgl",r)}catch(t){console.error(t),e()}return i.gl=n,i.setAsCurrent(),n.enable(n.CULL_FACE),r.customGLSetup&&r.customGLSetup(),i},i.size=function(r,e,n){return n=n||1,t.width=r*n,t.height=e*n,i.viewport(0,0,r*n,e*n),i},i.viewport=function(t,r,e,a){return n.viewport(t,r,e,a),i},i.clearColor=function(t,r,e,a){return n.clearColor(t,r,e,a),n.clear(n.COLOR_BUFFER_BIT),i},i.clear=function(){return n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT|n.STENCIL_BUFFER_BIT),i},i.setAsCurrent=function(){return SQR.gl=n,i},i.destroy=function(){n=null,t=null},i.create(r,e),i},SQR.Cubemap=function(t,r){var e={};e.tex=SQR.gl.createTexture();var n=6,i={};r=r||{};var a=function(){var t=SQR.gl;t.bindTexture(t.TEXTURE_CUBE_MAP,e.tex),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,i.right),t.texImage2D(t.TEXTURE_CUBE_MAP_NEGATIVE_X,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,i.left),t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_Y,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,i.up),t.texImage2D(t.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,i.down),t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_Z,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,i.front),t.texImage2D(t.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,i.back),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MIN_FILTER,t.LINEAR);var n=r.wrapS||r.wrap||t.CLAMP_TO_EDGE,a=r.wrapT||r.wrap||t.CLAMP_TO_EDGE;t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_S,n),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_T,a),t.generateMipmap(t.TEXTURE_CUBE_MAP),t.bindTexture(t.TEXTURE_CUBE_MAP,null),r.onLoad&&r.onLoad()},o=function(){--n<=0&&a()},s=function(t,r){"string"==typeof r?(i[t]=new Image,i[t].onload=o,i[t].src=r):(r instanceof Image||r.getContext)&&(i[t]=r,o())};return t.left?(s("left",t.left),s("right",t.right),s("up",t.up),s("down",t.down),s("back",t.back),s("front",t.front)):t&&(s("left",t),s("right",t),s("up",t),s("down",t),s("back",t),s("front",t)),e},SQR.FrameBuffer=function(t,r,e,n){t=t||window.innerWidth,r=r||window.innerHeight,n=n||{};var i={},a=SQR.gl;if(i.texture=a.createTexture(),i.depthBuffer=a.createRenderbuffer(),e){a.bindTexture(a.TEXTURE_CUBE_MAP,i.texture),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);for(var o=0;o<6;o++)a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+o,0,a.RGBA,t,r,0,a.RGBA,a.UNSIGNED_BYTE,null);a.bindRenderbuffer(a.RENDERBUFFER,i.depthBuffer),a.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_COMPONENT16,t,r);var s=function(t){var r=a.createFramebuffer();return a.bindFramebuffer(a.FRAMEBUFFER,r),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_CUBE_MAP_POSITIVE_X+t,i.texture,0),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.RENDERBUFFER,i.depthBuffer),a.bindFramebuffer(a.FRAMEBUFFER,null),r};i.faces={right:s(0),left:s(1),up:s(2),down:s(3),front:s(4),back:s(5)},a.bindTexture(a.TEXTURE_2D,null),a.bindRenderbuffer(a.RENDERBUFFER,null)}else{if(i.fbo=a.createFramebuffer(),a.bindFramebuffer(a.FRAMEBUFFER,i.fbo),a.bindTexture(a.TEXTURE_2D,i.texture),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,t,r,0,a.RGBA,a.UNSIGNED_BYTE,null),n.mipmap&&a.generateMipmap(a.TEXTURE_2D),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,n.magFilter||n.filter||a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,n.minFilter||n.filter||a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,n.wrapS||n.wrap||a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,n.wrapT||n.wrap||a.CLAMP_TO_EDGE),a.bindRenderbuffer(a.RENDERBUFFER,i.depthBuffer),a.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_COMPONENT16,t,r),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,i.texture,0),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.RENDERBUFFER,i.depthBuffer),n.leaveBind)return;a.bindTexture(a.TEXTURE_2D,null),a.bindRenderbuffer(a.RENDERBUFFER,null),a.bindFramebuffer(a.FRAMEBUFFER,null)}return i.bind=function(e){var n=i.faces?i.faces[e]:i.fbo;a.viewport(0,0,t,r),a.bindFramebuffer(a.FRAMEBUFFER,n)},i.unbind=function(){a.bindFramebuffer(a.FRAMEBUFFER,null),a.bindTexture(a.TEXTURE_2D,i.texture),n.mipmap&&a.generateMipmap(a.TEXTURE_2D)},i.resize=function(e,n){t=e,r=n,a.bindFramebuffer(a.FRAMEBUFFER,i.fbo),a.bindTexture(a.TEXTURE_2D,i.texture),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,t,r,0,a.RGBA,a.UNSIGNED_BYTE,null),a.bindRenderbuffer(a.RENDERBUFFER,i.depthBuffer),a.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_COMPONENT16,t,r),a.bindFramebuffer(a.FRAMEBUFFER,null),a.bindRenderbuffer(a.RENDERBUFFER,null)},i},SQR.Loader={loadText:function(t,r){var e=new XMLHttpRequest;e.open("GET",t);var n=function(){4==e.readyState&&(e.removeEventListener("readystatechange",n),r(e.responseText,t))};e.addEventListener("readystatechange",n),e.send()},loadJSON:function(t,r){SQR.Loader.loadText(t,function(e){r(JSON.parse(e),t)})},loadImage:function(t,r,e){var n=new Image;if(r){var i=function(){n.removeEventListener("load",i),r(n,t)};n.addEventListener("load",i)}if(e){var a=function(){return n.src="",n.removeEventListener("error",a),e(null,t),!1};n.addEventListener("error",a)}return n.src=t,n},loadWebcam:function(t,r){navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,navigator.getUserMedia||(console.error("> SQR.Loader - getUserMedia not supported"),t()),r=r||{audio:!1,video:{}};var e=function(t){i.stream=t,i.src=window.URL.createObjectURL(t),i.play(),i.addEventListener("canplaythrough",n,!1)},n=function(){t(i,"webcam")},i=document.createElement("video");i.autoplay=!0,navigator.getUserMedia(r,e,function(t){console.error("> SQR.Loader - getUserMedia error ",t)})},loadVideo:function(t,r){var e=function(){r(n,t)},n=document.createElement("video");n.autoplay=!0,n.addEventListener("canplaythrough",e,!1);var i=t;n.canPlayType("video/mp4")||(i=i.replace("mp4","webm")),n.src=i},loadAssets:function(t,r,e,n){n=n||{};var i=t.length,a={};if(0==i)return e&&e(1,1),void r();for(var o={},s=function(t,r){SQR.GLSLInclude=SQR.GLSLInclude||{},SQR.GLSLInclude[o[r]]=t,u(t,r)},u=function(n,s){a[o[s]]=n,i--,e&&e(i,t.length),0==i&&r(a)},c=0;c<i;c++){var l=t[c],f="string"!=typeof l,h=f?l[0]:l,d=f?l[1]:l,v=h.substring(h.lastIndexOf(".")+1);switch(o[h]=d,v){case"glsl":SQR.Loader.loadText(h,s);break;case"png":case"jpg":case"gif":SQR.Loader.loadImage(h,u);break;case"json":case"js":SQR.Loader.loadJSON(h,u);break;case"mp4":case"webm":SQR.Loader.loadVideo(h,u);break;case"webcam":SQR.Loader.loadWebcam(u)}}}},SQR.Pointer3d=function(t){t=t||{};var r=-2,e=0,n=new SQR.Ray,i=[];document.addEventListener("mousemove",function(t){r=t.pageX/window.innerWidth*2-1,e=t.pageY/window.innerHeight*2-1});var a=function(t,r){return t.collider.__hit<r.collider.__hit?-1:t.collider.__hit>r.collider.__hit?1:0};return{all:t.all||!1,ray:n,onTransform:function(e){if(e.collider&&-2!=r){var a=SQR.Intersection.rayTest(n,e);t.all?e.collider.hit=a:(e.collider.hit=!1,e.collider.__hit=a),a&&i.push(e)}},onAfterRender:function(){-2!=r&&!t.all&&i.length>0&&(i.sort(a),i[0].collider.hit=i[0].collider.__hit)},fromMousePosition:function(t,a,o){var s=SQR.Ray._mt,u=o?o.x:r,c=o?o.y:e;return n.origin.set(u,-1*c,0),s.copyFrom(a).inverse(),s.transformVector(n.origin),t.globalMatrix.transformVector(n.origin),n.direction.sub(n.origin,t.globalPosition).norm(),i.length=0,n}}},SQR.Ray=function(t,r){this.origin=t||new SQR.V3,this.direction=r||new SQR.V3,this.localOrigin=new SQR.V3,this.localDirection=new SQR.V3,SQR.Ray._mt||(SQR.Ray._mt=new SQR.Matrix44,SQR.Ray._nt=new SQR.Matrix33)},SQR.Ray.prototype.makeLocal=function(t){var r=SQR.Ray._mt,e=SQR.Ray._nt;r.copyFrom(t.globalMatrix).inverse(),r.transformVector(this.origin,this.localOrigin),e.copyFrom(t.normalMatrix).transpose(),e.transformVector(this.direction,this.localDirection)},SQR.Renderer=function(t,r,e){var n;n=t&&t.setAsCurrent?t:SQR.Context(t,r,e);var i,a,o,s,u={currentTime:0,deltaTime:0,autoClear:!0,context:n},c=[],l=[],f=function(t,r,e){if(t.active){if(t.__transformed||(t.transformWorld(),t.__transformed=!1),t.transformView(r?r.inverseWorldMatrix:null),t.clip&&t.clip.update(t,a,u.deltaTime),e.pointer3d&&e.pointer3d.onTransform(t),t.numChildren>0)for(var n=0;n<t.numChildren;n++)f(t.children[n],r,e);t.buffer&&t.shader&&(t.transparent?l.push(t):c.push(t))}},h={},d=[],v=function(t,r){t&&r.setUniform("uEyePosition",t.globalPosition);var e=t&&t.projection?t.projection:u.projection;e&&r.setUniform("uProjection",e).setUniform("uNear",e.near).setUniform("uFar",e.far),r.setUniform("uTime",a)};return u.clearColor=function(t,r,e,i){return null!=t.r?(void 0==t.a&&(t.a=1),n.gl.clearColor(t.r,t.g,t.b,t.a)):(void 0==i&&(i=1),n.gl.clearColor(t,r,e,i)),n.gl.clear(SQR.gl.COLOR_BUFFER_BIT),u},u.render=function(t,r,e){n.setAsCurrent(),u.tick(),u.beforeDraw(r,e),u.update(t,r,e),u.draw(null,r,e),u.afterDraw(e)},u.tick=function(){return i||(i=(new Date).getTime()),a=(new Date).getTime()-i,u.deltaTime=a-u.currentTime,u.currentTime=a,u},u.beforeDraw=function(t,r){if(r=r||h,r.pointer3d){var e=t&&t.projection?t.projection:u.projection;r.pointer3d.fromMousePosition(t||root,e)}return u},u.update=function(t,r,e){if(e=e||h,c.length=0,l.length=0,d.length=0,r){for(var n=r;n;)d.unshift(n),n=n.parent;for(var i=0,a=d.length;i<a;i++)d[i].transformWorld(),d[i].__transformed=!0;r.computeInverseMatrix()}return f(t,r,e),u},u.draw=function(t,r,e){var i=SQR.gl;e=e||h,u.autoClear&&n.clear(),i.enable(i.DEPTH_TEST),i.depthMask(!0),i.disable(i.STENCIL_TEST),i.frontFace(i.CW),e.customGLSetup&&e.customGLSetup(i),t&&t.buffer&&t.shader&&c.push(t),c=c.concat(l);var a,f=c.length,d=null,m=null,p=!1,R=e&&e.replacementShader;R&&(m=e.replacementShader.use().updateTextures(),v(r,m));for(var S=0;S<f;S++){o=!1,s=!1;var a=c[S];a.transparent&&(p||(i.enable(i.BLEND),p=!0),i.blendFunc(a.srcFactor,a.dstFactor)),d!=a.buffer&&(d=a.buffer,d.bind(),s=!0),m==a.shader||R||(m=a.shader.use().updateTextures(),v(r,m),o=!0),(o||s)&&m.attribPointers(d),a.draw(e)}return i.disable(i.BLEND),u},u.afterDraw=function(t){return t=t||h,t.pointer3d&&t.pointer3d.onAfterRender(),u},u.renderToScreen=function(){var t=SQR.gl;t.bindFramebuffer(t.FRAMEBUFFER,null)},u.clearColor(0,0,0,1),u},SQR.Shader=function(t,r){var e,n={},i={},a=[],o={},s=[],u=[],c=function(t){if(!t)throw"> SQR.Shader.parseGLSL - Shader source code missing";var e="",n=r?r.directives:null;if(n&&n instanceof Array)for(var i=0;i<n.length;i++)e+="#define "+n[i].name,n[i].value&&(e+=" "+n[i].value),e+="\n";for(var a=e,o=e,s=!0,u=t.split("\n"),i=0;i<u.length;i++){var c=u[i];if(c.indexOf("//#include")>-1){var l,f=c.substring(11);if(SQR.GLSL&&SQR.GLSL[f]?l=SQR.GLSL[f]:SQR.GLSLInclude&&SQR.GLSLInclude[f]?l=SQR.GLSLInclude[f]:r&&r.includes&&(l=r.includes[f]),!l)throw"> SQR.Shader.parseGLSL - Include not found: "+f;u[i]=l}}for(var u=u.join("\n").split("\n"),i=0;i<u.length;i++){var c=u[i];if(c.indexOf("//#")>-1)c.indexOf("//#fragment")>-1?s=!1:c.indexOf("//#vertex")>-1&&(s=!0);else{if(c.indexOf("//")>-1&&(c=c.substring(0,c.indexOf("//"))),c.match(/^([\s\t]*)$/))continue;s?a+=c+"\n":o+=c+"\n"}}return{vertex:a,fragment:o}};n.compile=function(){var r=c(t),i=SQR.gl,a=i.createShader(i.VERTEX_SHADER);i.shaderSource(a,r.vertex),i.compileShader(a);var o=i.createShader(i.FRAGMENT_SHADER);if(i.shaderSource(o,r.fragment),i.compileShader(o),e=i.createProgram(),i.attachShader(e,a),i.attachShader(e,o),i.linkProgram(e),!i.getShaderParameter(a,i.COMPILE_STATUS))throw"> SQR.Shader. Vertex shader compile error: "+i.getShaderInfoLog(a);if(!i.getShaderParameter(o,i.COMPILE_STATUS))throw"> SQR.Shader. Fragment shader compile error: "+i.getShaderInfoLog(o);if(!i.getProgramParameter(e,i.LINK_STATUS))throw"> SQR.Shader. Shader linking error: "+i.getProgramInfoLog(e);return n},n.inspect=function(){for(var t=SQR.gl,r=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES),c=0;c<r;c++){var l=t.getActiveAttrib(e,c);l.location=t.getAttribLocation(e,l.name),i[l.name]=l,a.push(l)}for(var f=t.getProgramParameter(e,t.ACTIVE_UNIFORMS),h=0,c=0;c<f;c++){var d=t.getActiveUniform(e,c);if(d.type!=t.SAMPLER_2D&&d.type!=t.SAMPLER_CUBE||(d.texId=h++,u.push(d)),d.name.indexOf("[")>-1)for(var v=d.name.substring(0,d.name.indexOf("[")),m=1;m<d.size;m++){var p=v+"["+m+"]",R={name:p,location:t.getUniformLocation(e,p),type:d.type};o[R.name]=R,s.push(R)}d.location=t.getUniformLocation(e,d.name),o[d.name]=d,s.push(d)}return n};n.getUniform=function(t){return o[t]},n.hasUniform=function(t){return null!=o[t]},n.setUniform=function(t,r){var e=SQR.gl,i="string"==typeof t?o[t]:t,a=r;if(!i){var s=o[t+"[0]"];if(s){for(var u=0;u<s.size;u++)r[u]&&n.setUniform(t+"["+u+"]",r[u]);return}return SQR.WARN_UNIFORM_NOT_PRESENT&&(console.warn("> SQR.Shader attempt to set uniform that does not exist: "+t),console.trace()),n}switch(a&&a.toUniform&&(a=a.toUniform(i.type)),i.type){case e.BYTE:case e.UNSIGNED_BYTE:case e.SHORT:case e.UNSIGNED_SHORT:case e.INT:e.uniform1i(i.location,a);break;case e.INT_VEC2:e.uniform2iv(i.location,a);break;case e.INT_VEC3:e.uniform3iv(i.location,a);break;case e.INT_VEC4:e.uniform4iv(i.location,a);break;case e.UNSIGNED_INT:e.uniform1i(i.location,a);break;case e.FLOAT:e.uniform1f(i.location,a);break;case e.FLOAT_VEC2:e.uniform2fv(i.location,a);break;case e.FLOAT_VEC3:e.uniform3fv(i.location,a);break;case e.FLOAT_VEC4:e.uniform4fv(i.location,a);break;case e.BOOL:e.uniform1i(i.location,a);break;case e.BOOL_VEC2:e.uniform2iv(i.location,a);break;case e.BOOL_VEC3:e.uniform3iv(i.location,a);break;case e.BOOL_VEC4:e.uniform4iv(i.location,a);break;case e.FLOAT_MAT2:e.uniformMatrix2fv(i.location,!1,a.data||a);break;case e.FLOAT_MAT3:e.uniformMatrix3fv(i.location,!1,a.data||a);break;case e.FLOAT_MAT4:e.uniformMatrix4fv(i.location,!1,a.data||a);break;case e.SAMPLER_2D:l(i,a);break;case e.SAMPLER_CUBE:f(i,a);break;default:console.warn("> SQR.Shader > WARNING! Unknown uniform type ( 0x"+i.type.toString(16)+" )")}return n};var l=function(t,r){var e=SQR.gl,n=t.texId;t.texref=r,e.activeTexture(e.TEXTURE0+n),r?(e.bindTexture(e.TEXTURE_2D,r.tex||r),r.isAnimated&&r.update()):e.bindTexture(e.TEXTURE_2D,null),e.uniform1i(t.location,n)},f=function(t,r){var e=SQR.gl,n=t.texId;t.texref=r,e.activeTexture(e.TEXTURE0+n),e.bindTexture(e.TEXTURE_CUBE_MAP,r.tex||r),e.uniform1i(t.location,n)};return n.updateTextures=function(){for(var t=(SQR.gl,0),r=u.length;t<r;t++){var e=u[t];e.texref&&n.setUniform(e,e.texref)}return n},n.use=function(){return SQR.gl.useProgram(e),n},n.attribPointers=function(t){var r=SQR.gl,e=a.length;t=t.buffer||t;for(var i=0;i<e;i++){var o=a[i],s=t.attributes[o.name];if(!s)throw"> SQR.Shader expects attribute "+o.name+" but geometry doesn't provide it";o.enabled||r.enableVertexAttribArray(o.location),r.vertexAttribPointer(o.location,s.size,r.FLOAT,!1,t.strideByteSize,s.byteOffset),o.enabled=!0}return n},r&&r.doNotCompile||(n.compile(),n.inspect()),n},SQR.Texture=function(t,r){var e,n={},i=SQR.gl,a=r||{};n.setSource=function(t,r){if(!(t instanceof HTMLVideoElement||t instanceof Image||t instanceof HTMLCanvasElement))throw console.error("Invalid source: "+t),"SQR.Texture > provided source is not a valid source for texture";e=t,a=r||a;var u=a.wrapS||a.wrap,c=a.wrapT||a.wrap;i.bindTexture(i.TEXTURE_2D,s),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,void 0===a.flip||a.flip),i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,void 0!==a.premultiplyAlpha&&a.premultiplyAlpha),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,e);var l,f;return o()?(a.mipmap&&i.generateMipmap(i.TEXTURE_2D),l=a.mipmap?i.LINEAR_MIPMAP_LINEAR:i.LINEAR,f=i.LINEAR):(a.mipmap&&console.warn("Only power-of-2 texture can use mipmaps\n",t),l=f=i.LINEAR),u||(u=i.CLAMP_TO_EDGE),c||(c=i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,a.magFilter||a.filter||f),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,a.minFilter||a.filter||l),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,u),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,c),i.bindTexture(i.TEXTURE_2D,null),n.isAnimated=a&&a.isAnimated||t instanceof HTMLVideoElement,n};var o=function(){var t=e.width,r=e.height;return t>0&&r>0&&0==(t&t-1)&&0==(r&r-1)};n.getSource=function(){return e},n.update=function(){var t=SQR.gl;return t.bindTexture(t.TEXTURE_2D,s),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),n},n.destroy=function(){i.deleteTexture(n.tex)};var s=i.createTexture();return n.tex=s,t&&n.setSource(t,r),n},SQR.Transform=function(t,r){if(!(this instanceof SQR.Transform))return new SQR.Transform(t,r);var e=this;e._transformState=0,e.uid=r,e.name=t||"sqr.transform."+SQR.TransformCount++,e.active=!0,e.directMatrixMode=!1,e.matrix=new SQR.Matrix44,e.position=new SQR.V3,e.globalPosition=new SQR.V3,e.forward=new SQR.V3,e.quaternion=new SQR.Quaternion,e.rotation=new SQR.V3,e.scale=new SQR.V3(1,1,1),e.useQuaternion=!1,e.isStatic=!1,e.normalMatrix=new SQR.Matrix33,e.globalMatrix=new SQR.Matrix44,e.viewMatrix=new SQR.Matrix44,e.inverseWorldMatrix,e.boneMatrix=new SQR.Matrix44,e.poseMatrix=new SQR.Matrix44,e.inversePoseMatrix=new SQR.Matrix44,e.lookAt=null,e.transparent=!1,e.srcFactor=null,e.dstFactor=null,e.useDepth=!0,e.depthMask=!0,e.lineWidth=1,e.children=[],e.numChildren=0},SQR.Transform.prototype.setAsBoneRoot=function(){this.computePoseMatrix()},SQR.Transform.prototype.computePoseMatrix=function(){var t=this;t.bone=!0,t.transformWorld(),t.parent&&t.parent.bone?(t.parent.poseMatrix.copyTo(t.poseMatrix),t.poseMatrix.multiply(t.matrix)):t.matrix.copyTo(t.poseMatrix);for(var r=0;r<t.numChildren;r++){t.children[r].computePoseMatrix()}return t.poseMatrix.inverse(t.inversePoseMatrix),t},SQR.Transform.prototype.setBlending=function(t,r,e){this.transparent=t,this.srcFactor=r||SQR.gl.SRC_ALPHA,this.dstFactor=e||SQR.gl.ONE_MINUS_SRC_ALPHA},SQR.Transform.prototype.add=function(){for(var t=this,r=0;r<arguments.length;r++){var e=arguments[r];e.parent&&e.parent.remove(e),e.onAdd&&e.onAdd(t),e.parent=t,-1==t.children.indexOf(e)&&t.children.push(e)}return t.numChildren=t.children.length,t},SQR.Transform.prototype.remove=function(){for(var t=this,r=0;r<arguments.length;r++){var e=arguments[r],n=t.children.indexOf(e);-1!=n&&(e.parent=null,t.children.splice(n,1),e.onRemove&&e.onRemove(t))}return t.numChildren=t.children.length,t},SQR.Transform.prototype.removeAll=function(){this.children.length=0,this.numChildren=0},SQR.Transform.prototype.contains=function(t){return this.children.indexOf(t)>-1},SQR.Transform.prototype.recurse=function(t,r){r||t(this);for(var e=0;e<this.numChildren;e++)this.children[e].recurse(t)},SQR.Transform.prototype.findByName=function(t){var r;return this.recurse(function(e){if(e.name==t)return r=e,null}),r},SQR.Transform.prototype.findById=function(t){var r;return this.recurse(function(e){if(e.uid&&e.uid==t)return r=e,null}),r},SQR.Transform.prototype.findByPath=function(t){for(var r=t.split("/"),e=this;pp=r.shift();){if(!e)return;e=e.findByName(pp)}return e},SQR.Transform.prototype.draw=function(t){var r=this,e=t&&t.replacementShader,n=e?t.replacementShader:r.shader;if(n.setUniform("uMatrix",r.globalMatrix),n.setUniform("uViewMatrix",r.viewMatrix),n.setUniform("uNormalMatrix",r.normalMatrix),!e&&n.uniforms)for(var i=Object.keys(n.uniforms),a=0,o=i.length;a<o;a++)n.setUniform(i[a],n.uniforms[i[a]]);if(!e&&r.uniforms)for(var i=Object.keys(r.uniforms),a=0,o=i.length;a<o;a++)n.setUniform(i[a],r.uniforms[i[a]]);var s=SQR.gl;r.useDepth?s.enable(s.DEPTH_TEST):s.disable(s.DEPTH_TEST),s.depthMask(r.depthMask),s.lineWidth(r.lineWidth),r.buffer.draw(this),r.afterDraw&&r.afterDraw()},SQR.Transform.prototype.transformWorld=function(){var t=this;if(1!=t._transformState){if(!t.directMatrixMode){var r=t.position,e=t.scale;if(t.useQuaternion){var n=t.quaternion;t.matrix.setTQS(r.x,r.y,r.z,n.w,n.x,n.y,n.z,e.x,e.y,e.z)}else{var i=t.rotation;t.matrix.setTRS(r.x,r.y,r.z,i.x,i.y,i.z,e.x,e.y,e.z)}}t.lookAt&&(t.matrix.lookAt(t.lookAt.position),t.matrix.scale(e.x,e.y,e.z)),t.parent?(t.parent.globalMatrix.copyTo(t.globalMatrix),t.globalMatrix.multiply(t.matrix),t.bone&&(t.parent.boneMatrix.copyTo(t.boneMatrix),t.boneMatrix.multiply(t.matrix))):(t.matrix.copyTo(t.globalMatrix),t.bone&&t.matrix.copyTo(t.boneMatrix));var a=t.globalMatrix;a.extractPosition(t.globalPosition),t.forward.set(a.data[8],a.data[9],a.data[10]),t.isStatic&&(t._transformState=1),t.beforeDraw&&t.beforeDraw(t)}},SQR.Transform.prototype.viewDepth=function(){return this.viewMatrix.data[14]},SQR.Transform.prototype.transformView=function(t){var r=this;t?(t.copyTo(r.viewMatrix),r.viewMatrix.multiply(r.globalMatrix),r.globalMatrix.inverseMat3(r.normalMatrix)):(r.globalMatrix.copyTo(r.viewMatrix),r.globalMatrix.inverseMat3(r.normalMatrix))},SQR.Transform.prototype.computeInverseMatrix=function(){var t=this;return t.inverseWorldMatrix||(t.inverseWorldMatrix=new SQR.Matrix44),t.globalMatrix.inverse(t.inverseWorldMatrix),t.inverseWorldMatrix},SQR.Transform.prototype.computeBoneMatrix=function(){var t=this;return t.boneMatrix.multiply(t.inversePoseMatrix),t.boneMatrix},SQR.TransformCount=0,SQR.Bezier=function(t,r,e,n){var i=this;this.p0=t,this.c0=r,this.c1=e,this.p1=n;var a,o,s,u=SQR.Interpolation.bezierPosition,c=SQR.Interpolation.bezierVelocity;this.velocityAt=function(t,r){return o=o||this.p0.clone().set(),r=r||o,r.x=c(t,this.p0.x,this.c0.x,this.c1.x,this.p1.x),r.y=c(t,this.p0.y,this.c0.y,this.c1.y,this.p1.y),null!==r.z&&null!==this.p0.z&&(r.z=c(t,this.p0.z,this.c0.z,this.c1.z,this.p1.z)),r},this.valueAt=function(t,r){return a=a||this.p0.clone().set(),r=r||a,r.x=u(t,this.p0.x,this.c0.x,this.c1.x,this.p1.x),r.y=u(t,this.p0.y,this.c0.y,this.c1.y,this.p1.y),null!==r.z&&null!==this.p0.z&&(r.z=u(t,this.p0.z,this.c0.z,this.c1.z,this.p1.z)),r},this.matrixAt=function(t,r){s=s||new SQR.Matrix44,r=r||s,r.identity();var e=i.valueAt(t),n=i.velocityAt(t).norm(),a=SQR.V3.__tv1.set().cross(n,SQR.V3.up),o=SQR.V3.__tv2.set().cross(n,a);return r.data[0]=a.x,r.data[4]=o.x,r.data[8]=n.x,r.data[1]=a.y,r.data[5]=o.y,r.data[9]=n.y,r.data[2]=a.z,r.data[6]=o.z,r.data[10]=n.z,r.setTranslation(e.x,e.y,e.z),r}},SQR.Color=function(t,r,e,n){if(!(this instanceof SQR.Color))return new SQR.Color(t,r,e,n);"string"==typeof t?(this.setHex(t),this.a=void 0==r?1:r):t&&void 0!=t.r?(this.setRGB(t.r,t.g,t.b),void 0!=t.a?this.a=t.a:this.a=void 0!=r?r:1):(this.setRGB(t,r,e),this.a=void 0==n?1:n)},SQR.Color.prototype.setRGB=function(t,r,e){var n=this;return n.r=t||0,n.g=r||0,n.b=e||0,n},SQR.Color.prototype.setHex=function(t){var r=this;return"string"==typeof t&&(t=0==t.indexOf("#")?t.substring(1):t,
t=-1==t.indexOf("0x")?"0x"+t:t,t=parseInt(t)),r.r=(t>>16&255)/255,r.g=(t>>8&255)/255,r.b=(255&t)/255,r},SQR.Color.prototype.toCSS=function(){var t=this;return"rgb("+(255*t.r|0)+", "+(255*t.g|0)+", "+(255*t.b|0)+")"},SQR.Color.prototype.copyFrom=function(t){var r=this;return r.r=t.r,r.g=t.g,r.b=t.b,r},SQR.Color.prototype.lighten=function(t){return this.mul(t)},SQR.Color.prototype.clone=function(){return new SQR.Color(c.r,c.g,c.b)},SQR.Color.prototype.mul=function(t){var r=this;return r.r=Math.min(1,r.r*t),r.g=Math.min(1,r.g*t),r.b=Math.min(1,r.b*t),r},SQR.Color.prototype.lerp=function(t,r,e){var n=this,i=1-e;return n.r=t.r*i+r.r*e,n.g=t.g*i+r.g*e,n.b=t.b*i+r.b*e,n},SQR.Color.prototype.toUniform=function(t){var r=t==SQR.gl.FLOAT_VEC4,e=this;return e._array||(e._array=new Float32Array(r?4:3)),e._array[0]=e.r,e._array[1]=e.g,e._array[2]=e.b,r&&(e._array[3]=e.a),e._array},SQR.Delaunay=function(){function t(t,r){var n=[];return r=r.filter(function(r){return!r.vertexInCircumcircle(t)||(n.push(new e(r.v0,r.v1)),n.push(new e(r.v1,r.v2)),n.push(new e(r.v2,r.v0)),!1)}),n=i(n),n.forEach(function(e){r.push(new SQR.Triangle(e.v0,e.v1,t))}),r}var r={},e=function(t,r){this.v0=t,this.v1=r};e.prototype.equals=function(t){return this.v0===t.v0&&this.v1===t.v1},e.prototype.inverse=function(){return new e(this.v1,this.v0)};var n=function(t){var r,e,n,i;t.forEach(function(t){(void 0===r||t.x<r)&&(r=t.x),(void 0===e||t.y<e)&&(e=t.y),(void 0===n||t.x>n)&&(n=t.x),(void 0===i||t.y>i)&&(i=t.y)});var a=10*(n-r),o=10*(i-e),s=t[0].clone().set(r-a,e-3*o),u=t[0].clone().set(r-a,i+o),c=t[0].clone().set(n+3*a,i+o);return new SQR.Triangle(s,u,c)},i=function(t){for(var r=[],e=0;e<t.length;++e){for(var n=t[e],i=!0,a=0;a<t.length;++a)if(e!==a){var o=t[a];if(n.equals(o)||n.inverse().equals(o)){i=!1;break}}i&&r.push(n)}return r};return r.triangulate=function(r){var e=[],i=n(r);return e.push(i),r.forEach(function(r){e=t(r,e)}),e=e.filter(function(t){return!(t.v0==i.v0||t.v0==i.v1||t.v0==i.v2||t.v1==i.v0||t.v1==i.v1||t.v1==i.v2||t.v2==i.v0||t.v2==i.v1||t.v2==i.v2)})},r}(),SQR.Interpolation={bezierPosition:function(t,r,e,n,i){return r*(1-t)*(1-t)*(1-t)+3*e*t*(1-t)*(1-t)+3*n*t*t*(1-t)+i*t*t*t},bezierVelocity:function(t,r,e,n,i){return 3*e-3*r+2*(3*r-6*e+3*n)*t+3*(3*e-r-3*n+i)*t*t},linear:function(t,r,e){return e<=t?t:e>=r?r:(e=(e-t)/(r-t),t+(r-t)*e)},smoothStep:function(t){return 3*t*t-2*t*t*t},quadIn:function(t){return t*t},quadOut:function(t){return t*(2-t)},quadInOut:function(t){return(t*=2)<1?.5*t*t:-.5*(--t*(t-2)-1)}},SQR.Intersection={},SQR.Intersection.rayTest=function(t,r){if(!r.collider)return console.log("Intersection test failed. "+r.name+" has no collider."),!1;switch(SQR.Intersection.__tv1||(SQR.Intersection.__tv1=new SQR.V3,SQR.Intersection.__tv2=new SQR.V3,SQR.Intersection.__tv3=new SQR.V3,SQR.Intersection.__tv4=new SQR.V3,SQR.Intersection.__tv5=new SQR.V3,SQR.Intersection.__tv6=new SQR.V3,SQR.Intersection.__tv7=new SQR.V3),r.collider.type){case SQR.Collider.SPHERE:return SQR.Intersection.raySphere(t,r);case SQR.Collider.BOX:return SQR.Intersection.rayBox(t,r);case SQR.Collider.MESH:return SQR.Intersection.rayMesh(t,r);default:throw console.log(r.collider),"> SQR.Intersection > unknown collider type on "+r.name}},SQR.Intersection.rayMesh=function(t,r){if(r.collider.box){if(!SQR.Intersection.rayBox(t,r))return!1}else t.makeLocal(r);for(var e=r.buffer.getDataArray(),n=r.buffer.getIndexArray(),i=r.buffer.attributes.aPosition.offset,a=!1,o=SQR.Intersection.__tv1,s=SQR.Intersection.__tv2,u=SQR.Intersection.__tv3,c=0;c<n.length;c+=3){var l=n[c+0]*r.buffer.strideSize+i,f=n[c+1]*r.buffer.strideSize+i,h=n[c+2]*r.buffer.strideSize+i;if(o.set(e[l],e[l+1],e[l+2]),s.set(e[f],e[f+1],e[f+2]),u.set(e[h],e[h+1],e[h+2]),a=a||SQR.Intersection.rayTriangle(t,o,s,u))break}return a},SQR.Intersection.rayTriangle=function(t,r,e,n,i){var a=SQR.Intersection.__tv4,i=SQR.Intersection.__tv5,o=SQR.Intersection.__tv6,s=SQR.Intersection.__tv7;o.sub(r,e),s.sub(n,r),i.cross(o,s).norm();var u=SQR.V3.dot(i,t.localDirection);if(!(u<0))return!1;var c=SQR.V3.dot(i,r),l=c-SQR.V3.dot(i,t.localOrigin);if(!(l<=0))return!1;l/=u,a.copyFrom(t.localDirection),a=a.norm().mul(l),a.add(t.localOrigin);var f,h,d,v,m,p;Math.abs(i.x)>Math.abs(i.y)?Math.abs(i.x)>Math.abs(i.z)?(f=a.y-r.y,h=e.y-r.y,d=n.y-r.y,v=a.z-r.z,m=e.z-r.z,p=n.z-r.z):(f=a.x-r.x,h=e.x-r.x,d=n.x-r.x,v=a.y-r.y,m=e.y-r.y,p=n.y-r.y):Math.abs(i.y)>Math.abs(i.z)?(f=a.x-r.x,h=e.x-r.x,d=n.x-r.x,v=a.z-r.z,m=e.z-r.z,p=n.z-r.z):(f=a.x-r.x,h=e.x-r.x,d=n.x-r.x,v=a.y-r.y,m=e.y-r.y,p=n.y-r.y);var R=h*p-m*d;if(0==R)return!1;R=1/R;var S=(f*p-v*d)*R;if(!(S>=0))return!1;var y=(h*v-m*f)*R;return y>=0&&(1-S-y>=0&&l)},SQR.Intersection.raySphere=function(t,r){var e=SQR.Intersection.__tv1,n=r.collider.radius,i=n*n;if(t.makeLocal(r),e.sub(r.collider.center,t.localOrigin),e.lengthSq<i)return!1;var a=SQR.V3.dot(e,t.localDirection);if(a<=0)return!1;var r=i-(e.magsq()-a*a);return r>=0&&Math.abs(a)-Math.sqrt(r)},SQR.Intersection.rayBox=function(t,r){var e=r.collider.box;t.makeLocal(r);var n=0,i=0,a=0,o=!0;if(t.localOrigin.x<e.minX?(n=e.minX-t.localOrigin.x,n/=t.localDirection.x,o=!1,-1):t.localOrigin.x>e.maxX&&(n=e.maxX-t.localOrigin.x,n/=t.localDirection.x,o=!1,1),t.localOrigin.y<e.minY?(i=e.minY-t.localOrigin.y,i/=t.localDirection.y,o=!1,-1):t.localOrigin.y>e.maxY&&(i=e.maxY-t.localOrigin.y,i/=t.localDirection.y,o=!1,1),t.localOrigin.z<e.minZ?(a=e.minZ-t.localOrigin.z,a/=t.localDirection.z,o=!1,-1):t.localOrigin.z>e.maxZ&&(a=e.maxZ-t.localOrigin.z,a/=t.localDirection.z,o=!1,1),o)return-1;var s=0,u=n;switch(i>u&&(s=1,u=i),a>u&&(s=2,u=a),s){case 0:var c=t.localOrigin.y+t.localDirection.y*u;if(c<e.minY||c>e.maxY)return!1;var l=t.localOrigin.z+t.localDirection.z*u;if(l<e.minZ||l>e.maxZ)return!1;break;case 1:var f=t.localOrigin.x+t.localDirection.x*u;if(f<e.minX||f>e.maxX)return!1;var l=t.localOrigin.z+t.localDirection.z*u;if(l<e.minZ||l>e.maxZ)return!1;break;case 2:var f=t.localOrigin.x+t.localDirection.x*u;if(f<e.minX||f>e.maxX)return!1;var c=t.localOrigin.y+t.localDirection.y*u;if(c<e.minY||c>e.maxY)return!1}return u},Math.clamp=function(t,r,e){return t<=r?r:t>=e?e:t},Math.clamp01=function(t){return t<=0?0:t>=1?1:t},Math.absMin=function(t,r){return t<=-r||t>=r?t:t>=0?r:-r},Math.map=function(t,r,e){return t<=r?0:t>=e?1:(t-r)/(e-r)},SQR.Matrix2D=function(){this.data=new Float32Array(9);var t,r,e,n,i;this.identity=function(t){return t=t||this.data,t[0]=1,t[3]=0,t[6]=0,t[1]=0,t[4]=1,t[7]=0,t[2]=0,t[5]=0,t[8]=1,this},this.transformVector=function(t){return e=this.data,n=t.x,i=t.y,t.x=e[0]*n+e[1]*i+e[2],t.y=e[3]*n+e[4]*i+e[5],t},this.setTranslation=function(t,r,n){return e=n||this.data,e[0]=1,e[3]=0,e[6]=t,e[1]=0,e[4]=1,e[7]=r,e[2]=0,e[5]=0,e[8]=1,this},this.getTranslation=function(t){return e=this.data,t=t||new SQR.V2,t.x=e[2],t.y=e[5],t},this.setScale=function(t,r,n){return e=n||this.data,e[0]=t,e[3]=0,e[6]=0,e[1]=0,e[4]=r,e[7]=0,e[2]=0,e[5]=0,e[8]=1,this},this.setShear=function(t,r,n){return e=n||this.data,e[0]=1,e[3]=t,e[6]=0,e[1]=r,e[4]=1,e[7]=0,e[2]=0,e[5]=0,e[8]=1,this},this.setRotation=function(t,r){e=r||this.data;var n=Math.cos(t),i=Math.sin(t);return e[0]=n,e[3]=-i,e[6]=0,e[1]=i,e[4]=n,e[7]=0,e[2]=0,e[5]=0,e[8]=1,this},this.setTRS=function(t,r,n,i,a){e=this.data;var o=Math.cos(n),s=Math.sin(n);return e[0]=o*i,e[3]=-s*a,e[6]=t,e[1]=s*i,e[4]=o*a,e[7]=r,e[2]=0,e[5]=0,e[8]=1,this},this.translate=function(t,r){return this.identity(SQR.Matrix2D.__temp),this.setTranslation(t,r,SQR.Matrix2D.__temp),this.multiply(SQR.Matrix2D.__temp)},this.rotate=function(t){return this.identity(SQR.Matrix2D.__temp),this.setRotation(t,SQR.Matrix2D.__temp),this.multiply(SQR.Matrix2D.__temp)},this.scale=function(t,r){return this.identity(SQR.Matrix2D.__temp),this.setScale(t,r,SQR.Matrix2D.__temp),this.multiply(SQR.Matrix2D.__temp)},this.shear=function(t,r){return this.identity(SQR.Matrix2D.__temp),this.setRotation(t,r,SQR.Matrix2D.__temp),this.multiply(SQR.Matrix2D.__temp)};var a,o,s,u,c,l,f,h,d,v,m,p,R,S,y,x,Q,g;this.multiply=function(e){return t=this.data,r=e.data||e,a=t[0],o=t[3],s=t[6],u=t[1],c=t[4],l=t[7],f=t[2],h=t[5],d=t[8],v=r[0],m=r[3],p=r[6],R=r[1],S=r[4],y=r[7],x=r[2],Q=r[5],g=r[8],t[0]=a*v+o*R+s*x,t[3]=a*m+o*S+s*Q,t[6]=a*p+o*y+s*g,t[1]=u*v+c*R+l*x,t[4]=u*m+c*S+l*Q,t[7]=u*p+c*y+l*g,this},this.copyTo=function(e){return t=this.data,r=e.data||e,r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],r[4]=t[4],r[5]=t[5],r[6]=t[6],r[7]=t[7],r[8]=t[8],e},this.copyFrom=function(e){return t=e.data||e,r=this.data,r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],r[4]=t[4],r[5]=t[5],r[6]=t[6],r[7]=t[7],r[8]=t[8],this},this.identity()},SQR.Matrix2D.__temp=new Float32Array(9),SQR.Matrix33=function(){this.data=new Float32Array(9),this.identity=function(){var t=this.data;return t[0]=1,t[3]=0,t[6]=0,t[1]=0,t[4]=1,t[7]=0,t[2]=0,t[5]=0,t[8]=1,this},this.copyTo=function(t){for(var r=this.data,e=t.data||t,n=0;n<9;n++)e[n]=r[n];return this},this.copyFrom=function(t){for(var r=this.data,e=t.data||t,n=0;n<9;n++)r[n]=e[n];return this},this.transformVector=function(t,r){var e=this.data,n=t.x,i=t.y,a=t.z;return r=r||t,r.x=e[0]*n+e[3]*i+e[6]*a,r.y=e[1]*n+e[4]*i+e[7]*a,r.z=e[2]*n+e[5]*i+e[8]*a,r},this.determinant=function(){var t=this.data;return t[0]*(t[4]*t[8]-t[7]*t[5])+t[3]*(t[7]*t[2]-t[1]*t[8])+t[6]*(t[1]*t[5]-t[4]*t[2])},this.inverse=function(t){var r=this.data;t=t||this.data;var e,n=r[0],i=r[1],a=r[2],o=r[3],s=r[4],u=r[5],c=r[6],l=r[7],f=r[8],h=f*s-u*l,d=-f*o+u*c,v=l*o-s*c,r=n*h+i*d+a*v;return r?(e=1/r,t[0]=h*e,t[1]=(-f*i+a*l)*e,t[2]=(u*i-a*s)*e,t[3]=d*e,t[4]=(f*n-a*c)*e,t[5]=(-u*n+a*o)*e,t[6]=v*e,t[7]=(-l*n+i*c)*e,t[8]=(s*n-i*o)*e,t):(console.warn("Attempt to inverse a singular matrix33. ",this.data),t)},this.transpose=function(){var t=this.data,r=t[0],e=t[3],n=t[6],i=t[1],a=t[4],o=t[7],s=t[2],u=t[5],c=t[8];t[0]=r,t[1]=e,t[2]=n,t[3]=i,t[4]=a,t[5]=o,t[6]=s,t[7]=u,t[8]=c}},SQR.Matrix44=function(t){this.data=t||new Float32Array(16),this.identity=function(t){var r=t||this.data;return r[0]=1,r[4]=0,r[8]=0,r[12]=0,r[1]=0,r[5]=1,r[9]=0,r[13]=0,r[2]=0,r[6]=0,r[10]=1,r[14]=0,r[3]=0,r[7]=0,r[11]=0,r[15]=1,this},this.transformVector=function(t,r){var e=this.data,n=t.x,i=t.y,a=t.z,o=t.w;return r=r||t,r.x=e[0]*n+e[4]*i+e[8]*a+e[12]*o,r.y=e[1]*n+e[5]*i+e[9]*a+e[13]*o,r.z=e[2]*n+e[6]*i+e[10]*a+e[14]*o,r},this.rotateVector=function(t,r){var e=this.data,n=t.x,i=t.y,a=t.z;t.w;return r=r||t,r.x=e[0]*n+e[4]*i+e[8]*a,r.y=e[1]*n+e[5]*i+e[9]*a,r.z=e[2]*n+e[6]*i+e[10]*a,r},this.multiply=function(t){var r,e,n,i,a,o,s,u,c,l,f,h,d,v,m,p,R,S,y,x,Q,g,E,T,_,M,b,w,A,V,P,U,F=this.data,z=t.data||t;return r=F[0],e=F[1],n=F[2],i=F[3],a=F[4],o=F[5],s=F[6],u=F[7],c=F[8],l=F[9],f=F[10],h=F[11],d=F[12],v=F[13],m=F[14],p=F[15],R=z[0],S=z[1],y=z[2],x=z[3],Q=z[4],g=z[5],E=z[6],T=z[7],_=z[8],M=z[9],b=z[10],w=z[11],A=z[12],V=z[13],P=z[14],U=z[15],F[0]=r*R+a*S+c*y+d*x,F[1]=e*R+o*S+l*y+v*x,F[2]=n*R+s*S+f*y+m*x,F[3]=i*R+u*S+h*y+p*x,F[4]=r*Q+a*g+c*E+d*T,F[5]=e*Q+o*g+l*E+v*T,F[6]=n*Q+s*g+f*E+m*T,F[7]=i*Q+u*g+h*E+p*T,F[8]=r*_+a*M+c*b+d*w,F[9]=e*_+o*M+l*b+v*w,F[10]=n*_+s*M+f*b+m*w,F[11]=i*_+u*M+h*b+p*w,F[12]=r*A+a*V+c*P+d*U,F[13]=e*A+o*V+l*P+v*U,F[14]=n*A+s*V+f*P+m*U,F[15]=i*A+u*V+h*P+p*U,this},this.setTQS=function(t,r,e,n,i,a,o,s,u,c,l){var f=l||this.data;this.identity(l);var h=i*i,d=a*a,v=o*o;return SQR.flipMatrix?(f[0]=(1-2*d-2*v)*s,f[1]=(2*i*a-2*o*n)*s,f[2]=(2*i*o+2*a*n)*s,f[4]=(2*i*a+2*o*n)*u,f[5]=(1-2*h-2*v)*u,f[6]=(2*a*o-2*i*n)*u,f[8]=(2*i*o-2*a*n)*c,f[9]=(2*a*o+2*i*n)*c,f[10]=(1-2*h-2*d)*c):(f[0]=(1-2*d-2*v)*s,f[4]=(2*i*a-2*o*n)*s,f[8]=(2*i*o+2*a*n)*s,f[1]=(2*i*a+2*o*n)*u,f[5]=(1-2*h-2*v)*u,f[9]=(2*a*o-2*i*n)*u,f[2]=(2*i*o-2*a*n)*c,f[6]=(2*a*o+2*i*n)*c,f[10]=(1-2*h-2*d)*c),f[12]=t,f[13]=r,f[14]=e,l||this},this.setTRS=function(t,r,e,n,i,a,o,s,u,c){var l=c||this.data;this.identity(c);var f=Math.sin(n),h=Math.cos(n),d=Math.sin(i),v=Math.cos(i),m=Math.sin(a),p=Math.cos(a);return SQR.flipMatrix?(l[0]=(v*p+d*f*m)*o,l[1]=(-v*m+d*f*p)*o,l[2]=d*h*o,l[4]=m*h*s,l[5]=p*h*s,l[6]=-f*s,l[8]=(-d*p+v*f*m)*u,l[9]=(m*d+v*f*p)*u,l[10]=v*h*u):(l[0]=(v*p+d*f*m)*o,l[4]=(-v*m+d*f*p)*o,l[8]=d*h*o,l[1]=m*h*s,l[5]=p*h*s,l[9]=-f*s,l[2]=(-d*p+v*f*m)*u,l[6]=(m*d+v*f*p)*u,l[10]=v*h*u),l[12]=t,l[13]=r,l[14]=e,c||this},this.setScale=function(t,r,e,n){var i=n||this.data;return i[0]=t,i[5]=r,i[10]=e,n||this},this.setTranslation=function(t,r,e,n){var i=n||this.data;return i[12]=t,i[13]=r,i[14]=e,n||this},this.setRotation=function(t,r,e,n){var i=n||this.data,a=Math.sin(t),o=Math.cos(t),s=Math.sin(r),u=Math.cos(r),c=Math.sin(e),l=Math.cos(e);return i[0]=u*l+s*a*c,i[1]=-u*c+s*a*l,i[2]=s*o,i[4]=c*o,i[5]=l*o,i[6]=-a,i[8]=-s*l+u*a*c,i[9]=c*s+u*a*l,i[10]=u*o,n||this},this.translate=function(t,r,e){return this.identity(SQR.Matrix44.__temp),this.setTranslation(t,r,e,SQR.Matrix44.__temp),this.multiply(SQR.Matrix44.__temp)},this.rotate=function(t,r,e){return this.identity(SQR.Matrix44.__temp),this.setRotation(t,r,e,SQR.Matrix44.__temp),this.multiply(SQR.Matrix44.__temp)},this.scale=function(t,r,e){return this.identity(SQR.Matrix44.__temp),this.setScale(t,r,e,SQR.Matrix44.__temp),this.multiply(SQR.Matrix44.__temp)},this.copyTo=function(t){for(var r=this.data,e=t.data||t,n=0;n<16;n++)e[n]=r[n];return this},this.copyFrom=function(t){for(var r=this.data,e=t.data||t,n=0;n<16;n++)r[n]=e[n];return this},this.copyRotationTo=function(t){var r=this.data,e=t.data||t;return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[4],e[4]=r[5],e[5]=r[6],e[6]=r[8],e[7]=r[9],e[8]=r[10],t},this.extractPosition=function(t){var r=this.data;return t.set(r[12],r[13],r[14]),t},this.determinant=function(){var t=this.data;return t[0]*(t[5]*t[10]-t[9]*t[6])+t[4]*(t[9]*t[2]-t[1]*t[10])+t[8]*(t[1]*t[6]-t[5]*t[2])},this.inverse=function(t){var r=this.data,e=t?t.data||t:this.data,n=r[0],i=r[1],a=r[2],o=r[3],s=r[4],u=r[5],c=r[6],l=r[7],f=r[8],h=r[9],d=r[10],v=r[11],m=r[12],p=r[13],R=r[14],S=r[15],y=n*u-i*s,x=n*c-a*s,Q=n*l-o*s,g=i*c-a*u,E=i*l-o*u,T=a*l-o*c,_=f*p-h*m,M=f*R-d*m,b=f*S-v*m,w=h*R-d*p,A=h*S-v*p,V=d*S-v*R,P=y*V-x*A+Q*w+g*b-E*M+T*_;return P?(P=1/P,e[0]=(u*V-c*A+l*w)*P,e[1]=(a*A-i*V-o*w)*P,e[2]=(p*T-R*E+S*g)*P,e[3]=(d*E-h*T-v*g)*P,e[4]=(c*b-s*V-l*M)*P,e[5]=(n*V-a*b+o*M)*P,e[6]=(R*Q-m*T-S*x)*P,e[7]=(f*T-d*Q+v*x)*P,e[8]=(s*A-u*b+l*_)*P,e[9]=(i*b-n*A-o*_)*P,e[10]=(m*E-p*Q+S*y)*P,e[11]=(h*Q-f*E-v*y)*P,e[12]=(u*M-s*w-c*_)*P,e[13]=(n*w-i*M+a*_)*P,e[14]=(p*x-m*g-R*y)*P,e[15]=(f*g-h*x+d*y)*P,t):null},this.inverseMat3=function(t){var r=this.data,e=t.data,n=this.determinant();if(Math.abs(n)<1e-4)return console.warn("> SQR.Matrix44 - Attempt to inverse a singular matrix44. ",this.data),console.trace(),t;var i=r[0],a=r[4],o=r[8],s=(r[12],r[1]),u=r[5],c=r[9],l=(r[13],r[2]),f=r[6],h=r[10];r[14];return n=1/n,e[0]=(u*h-c*f)*n,e[1]=(o*f-a*h)*n,e[2]=(a*c-o*u)*n,e[3]=(c*l-s*h)*n,e[4]=(i*h-o*l)*n,e[5]=(o*s-i*c)*n,e[6]=(s*f-u*l)*n,e[7]=(a*l-i*f)*n,e[8]=(i*u-a*s)*n,t},this.transpose=function(t){var r=this.data,e=t?t.data||t:this.data,n=r[0],i=r[4],a=r[8],o=r[1],s=r[5],u=r[9],c=r[2],l=r[6],f=r[10];e[0]=n,e[1]=i,e[2]=a,e[4]=o,e[5]=s,e[6]=u,e[8]=c,e[9]=l,e[10]=f},this.lookAt=function(t,r){var e=this.data,n=SQR.V3.__tv1,i=SQR.V3.__tv2,a=SQR.V3.__tv3;return r=r||SQR.V3.up,a.set(e[12],e[13],e[14]),a.sub(a,t).norm(),0===a.magsq()&&(a.z=1),n.cross(r,a).norm(),0===n.magsq()&&(a.x+=1e-4,n.cross(r,a).norm()),i.cross(a,n),e[0]=n.x,e[4]=i.x,e[8]=a.x,e[1]=n.y,e[5]=i.y,e[9]=a.y,e[2]=n.z,e[6]=i.z,e[10]=a.z,this},t||this.identity()},SQR.Matrix44.__temp=new Float32Array(16),SQR.PerlinNoise=function(){function t(t,r,e){this.x=t,this.y=r,this.z=e}function r(t){return t*t*t*(t*(6*t-15)+10)}function e(t,r,e){return(1-e)*t+e*r}var n={};t.prototype.dot2=function(t,r){return this.x*t+this.y*r},t.prototype.dot3=function(t,r,e){return this.x*t+this.y*r+this.z*e};var i=[new t(1,1,0),new t(-1,1,0),new t(1,-1,0),new t(-1,-1,0),new t(1,0,1),new t(-1,0,1),new t(1,0,-1),new t(-1,0,-1),new t(0,1,1),new t(0,-1,1),new t(0,1,-1),new t(0,-1,-1)],a=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],o=new Array(512),s=new Array(512);n.seed=function(t){t>0&&t<1&&(t*=65536),(t=Math.floor(t))<256&&(t|=t<<8);for(var r=0;r<256;r++){var e;e=1&r?a[r]^255&t:a[r]^t>>8&255,o[r]=o[r+256]=e,s[r]=s[r+256]=i[e%12]}},n.seed(0);var u=.5*(Math.sqrt(3)-1),c=(3-Math.sqrt(3))/6,l=1/6;return n.simplex2=function(t,r){var e,n,i,a,l,f=(t+r)*u,h=Math.floor(t+f),d=Math.floor(r+f),v=(h+d)*c,m=t-h+v,p=r-d+v;m>p?(a=1,l=0):(a=0,l=1);var R=m-a+c,S=p-l+c,y=m-1+2*c,x=p-1+2*c;h&=255,d&=255;var Q=s[h+o[d]],g=s[h+a+o[d+l]],E=s[h+1+o[d+1]],T=.5-m*m-p*p;T<0?e=0:(T*=T,e=T*T*Q.dot2(m,p));var _=.5-R*R-S*S;_<0?n=0:(_*=_,n=_*_*g.dot2(R,S));var M=.5-y*y-x*x;return M<0?i=0:(M*=M,i=M*M*E.dot2(y,x)),70*(e+n+i)},n.simplex3=function(t,r,e){var n,i,a,u,c,f,h,d,v,m,p=(t+r+e)*(1/3),R=Math.floor(t+p),S=Math.floor(r+p),y=Math.floor(e+p),x=(R+S+y)*l,Q=t-R+x,g=r-S+x,E=e-y+x;Q>=g?g>=E?(c=1,f=0,h=0,d=1,v=1,m=0):Q>=E?(c=1,f=0,h=0,d=1,v=0,m=1):(c=0,f=0,h=1,d=1,v=0,m=1):g<E?(c=0,f=0,h=1,d=0,v=1,m=1):Q<E?(c=0,f=1,h=0,d=0,v=1,m=1):(c=0,f=1,h=0,d=1,v=1,m=0);var T=Q-c+l,_=g-f+l,M=E-h+l,b=Q-d+2*l,w=g-v+2*l,A=E-m+2*l,V=Q-1+.5,P=g-1+.5,U=E-1+.5;R&=255,S&=255,y&=255;var F=s[R+o[S+o[y]]],z=s[R+c+o[S+f+o[y+h]]],C=s[R+d+o[S+v+o[y+m]]],I=s[R+1+o[S+1+o[y+1]]],B=.6-Q*Q-g*g-E*E;B<0?n=0:(B*=B,n=B*B*F.dot3(Q,g,E));var N=.6-T*T-_*_-M*M;N<0?i=0:(N*=N,i=N*N*z.dot3(T,_,M));var L=.6-b*b-w*w-A*A;L<0?a=0:(L*=L,a=L*L*C.dot3(b,w,A));var D=.6-V*V-P*P-U*U;return D<0?u=0:(D*=D,u=D*D*I.dot3(V,P,U)),32*(n+i+a+u)},n.perlin2=function(t,n){var i=Math.floor(t),a=Math.floor(n);t-=i,n-=a,i&=255,a&=255;var u=s[i+o[a]].dot2(t,n),c=s[i+o[a+1]].dot2(t,n-1),l=s[i+1+o[a]].dot2(t-1,n),f=s[i+1+o[a+1]].dot2(t-1,n-1),h=r(t);return e(e(u,l,h),e(c,f,h),r(n))},n.perlin3=function(t,n,i){var a=Math.floor(t),u=Math.floor(n),c=Math.floor(i);t-=a,n-=u,i-=c,a&=255,u&=255,c&=255;var l=s[a+o[u+o[c]]].dot3(t,n,i),f=s[a+o[u+o[c+1]]].dot3(t,n,i-1),h=s[a+o[u+1+o[c]]].dot3(t,n-1,i),d=s[a+o[u+1+o[c+1]]].dot3(t,n-1,i-1),v=s[a+1+o[u+o[c]]].dot3(t-1,n,i),m=s[a+1+o[u+o[c+1]]].dot3(t-1,n,i-1),p=s[a+1+o[u+1+o[c]]].dot3(t-1,n-1,i),R=s[a+1+o[u+1+o[c+1]]].dot3(t-1,n-1,i-1),S=r(t),y=r(n),x=r(i);return e(e(e(l,v,S),e(f,m,S),x),e(e(h,p,S),e(d,R,S),x),y)},n}(),SQR.ProjectionMatrix=function(){"undefined"==typeof Float32Array&&(Float32Array=Array),this.data=new Float32Array(16),this.copyTo=function(t){for(var r=this.data,e=t.data||t,n=0;n<16;n++)e[n]=r[n];return t},this.identity()},SQR.ProjectionMatrix.getBoundsAtDistance=function(t,r,e,n){e=e||window.innerWidth,n=n||window.innerHeight;var i=e/n,a=Math.tan(t/180*Math.PI/2),o=r*a;return{w:o*i,h:o}},SQR.ProjectionMatrix.prototype.identity=function(){var t=this.data;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},SQR.ProjectionMatrix.prototype.screenPixels2d=function(){return this.orthographic(window.innerWidth,0,window.innerHeight,0,-1,1e3),this},SQR.ProjectionMatrix.prototype.orthographic=function(t,r,e,n,i,a){var o=this.data;this.near=i,this.far=a;var s=r-t,u=e-n,c=a-i,l=(r+t)/s,f=(e+n)/u,h=(a+i)/c;return o[0]=2/s,o[4]=0,o[8]=0,o[12]=-l,o[1]=0,o[5]=2/u,o[9]=0,o[13]=-f,o[2]=0,o[6]=0,o[10]=-2/c,o[14]=-h,o[3]=0,o[7]=0,o[11]=0,o[15]=1,this},SQR.ProjectionMatrix.prototype.perspective=function(t,r,e,n){t=t||60,e=e||1,n=n||1e3;var i=this.data,a=e*Math.tan(t*Math.PI/360),o=n-e;return i[0]=e/(a*r),i[4]=0,i[8]=0,i[12]=0,i[1]=0,i[5]=e/a,i[9]=0,i[13]=0,i[2]=0,i[6]=0,i[10]=-(n+e)/o,i[14]=-2*n*e/o,i[3]=0,i[7]=0,i[11]=-1,i[15]=0,this.fov=t,this.near=e,this.far=n,this},SQR.ProjectionMatrix.prototype.transformVector=function(t,r){var e=t.x,n=t.y,i=t.z,a=t.w,o=this.data;return r=r||t,r.x=o[0]*e+o[4]*n+o[8]*i+o[12]*a,r.y=o[1]*e+o[5]*n+o[9]*i+o[13]*a,r.z=o[2]*e+o[6]*n+o[10]*i+o[14]*a,r},SQR.Quaternion=function(t,r,e,n){this.set(n,t,r,e)},SQR.Quaternion.prototype.set=function(t,r,e,n){return this.w=n||1,this.x=t||0,this.y=r||0,this.z=e||0,this},SQR.Quaternion.prototype.copyTo=function(t){return t.x=this.x,t.y=this.y,t.z=this.z,t.w=this.w,this},SQR.Quaternion.prototype.copyFrom=function(t){return t instanceof Array?(this.x=t[0],this.y=t[1],this.z=t[2],this.w=t[3]):(this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w),this},SQR.Quaternion.prototype.identity=function(){return this.set(),this},SQR.Quaternion.prototype.mul=function(t,r){r=r||this;var e=r.w*t.w-r.x*t.x-r.y*t.y-r.z*t.z,n=r.w*t.x+r.x*t.w+r.y*t.z-r.z*t.y,i=r.w*t.y-r.x*t.z+r.y*t.w+r.z*t.x,a=r.w*t.z+r.x*t.y-r.y*t.x+r.z*t.w;return r.set(n,i,a,e),r.normalize(),r},SQR.Quaternion.prototype.dot=function(t){return this.x*v.x+this.y*v.y+this.z*v.z+this.w*v.w},SQR.Quaternion.prototype.lookAt=function(t,r){var e=SQR.Quaternion.__tv1,n=SQR.Quaternion.__tv2,i=SQR.Quaternion.__tv3;t.copyTo(e),r.copyTo(i),e.norm(),-1==e.z&&(e.x=1e-4,e.norm()),n.cross(i,e),i.cross(e,n),this.w=.5*Math.sqrt(1+n.x+i.y+e.z);var a=4*this.w;return this.x=(e.y-i.z)/a,this.y=(n.z-e.x)/a,this.z=(i.x-n.y)/a,this.normalize(),this},SQR.Quaternion.prototype.fromAngleAxis=function(t,r,e,n){var i=Math.sin(t/2);return this.x=r*i,this.y=e*i,this.z=n*i,this.w=Math.cos(t/2),this},SQR.Quaternion.prototype.mag=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},SQR.Quaternion.prototype.normalize=function(){var t=this.mag();return this.x/=t,this.y/=t,this.z/=t,this.w/=t,this},SQR.Quaternion.prototype.neg=function(){return this.x*=-1,this.y*=-1,this.z*=-1,this.w*=-1,this},SQR.Quaternion.prototype.toMatrix=function(t){throw"SQR.Quaternion.toMatrix() is not implemented. Check SQR.Matrix44.TQS()"},SQR.Quaternion.slerp=function(t,r,e,n){if(n=n||new SQR.Quaternion,0===e)return n.copyFrom(t);if(1===e)return n.copyFrom(r);var i=SQR.Quaternion.dot(t,r);i<0&&(t.neg(),i=SQR.Quaternion.dot(t,r));var a=Math.acos(i),o=Math.sqrt(1-i*i),s=Math.sin((1-e)*a)/o,u=Math.sin(e*a)/o;return Math.abs(i)>=1?(s=1,u=0):Math.abs(o)<.001&&(s=.5,u=.5),n.w=t.w*s+r.w*u,n.x=t.x*s+r.x*u,n.y=t.y*s+r.y*u,n.z=t.z*s+r.z*u,n},SQR.Quaternion.dot=function(t,r){return t.x*r.x+t.y*r.y+t.z*r.z+t.w*r.w},SQR.Quaternion.prototype.slerp=function(t,r,e){return SQR.Quaternion.slerp(t,r,e,this),this},SQR.Quaternion.__tv1=new SQR.Quaternion,SQR.Quaternion.__tv2=new SQR.Quaternion,SQR.Quaternion.__tv3=new SQR.Quaternion,function(t,r){function e(e,c,l){var R=[];c=1==c?{entropy:!0}:c||{};var S=o(a(c.entropy?[e,u(t)]:null==e?s():e,3),R),y=new n(R),x=function(){for(var t=y.g(h),r=v,e=0;t<m;)t=(t+e)*f,r*=f,e=y.g(1);for(;t>=p;)t/=2,r/=2,e>>>=1;return(t+e)/r};return x.int32=function(){return 0|y.g(4)},x.quick=function(){return y.g(4)/4294967296},x.double=x,o(u(y.S),t),(c.pass||l||function(t,e,n,a){return a&&(a.S&&i(a,y),t.state=function(){return i(y,{})}),n?(r[d]=t,e):t})(x,S,"global"in c?c.global:this==r,c.state)}function n(t){var r,e=t.length,n=this,i=0,a=n.i=n.j=0,o=n.S=[];for(e||(t=[e++]);i<f;)o[i]=i++;for(i=0;i<f;i++)o[i]=o[a=R&a+t[i%e]+(r=o[i])],o[a]=r;(n.g=function(t){for(var r,e=0,i=n.i,a=n.j,o=n.S;t--;)r=o[i=R&i+1],e=e*f+o[R&(o[i]=o[a=R&a+r])+(o[a]=r)];return n.i=i,n.j=a,e})(f)}function i(t,r){return r.i=t.i,r.j=t.j,r.S=t.S.slice(),r}function a(t,r){var e,n=[],i=typeof t;if(r&&"object"==i)for(e in t)try{n.push(a(t[e],r-1))}catch(t){}return n.length?n:"string"==i?t:t+"\0"}function o(t,r){for(var e,n=t+"",i=0;i<n.length;)r[R&i]=R&(e^=19*r[R&i])+n.charCodeAt(i++);return u(r)}function s(){try{if(c)return u(c.randomBytes(f));var r=new Uint8Array(f);return(l.crypto||l.msCrypto).getRandomValues(r),u(r)}catch(r){var e=l.navigator,n=e&&e.plugins;return[+new Date,l,n,l.screen,u(t)]}}function u(t){return String.fromCharCode.apply(0,t)}var c,l=this,f=256,h=6,d="random",v=r.pow(f,h),m=r.pow(2,52),p=2*m,R=f-1;if(r["seed"+d]=e,o(r.random(),t),"object"==typeof module&&module.exports){module.exports=e;try{c=require("crypto")}catch(t){}}else"function"==typeof define&&define.amd&&define(function(){return e})}([],Math),SQR.Spline=function(){var t,r,e=[],n=[],i=[],a={},o=function(e,n,i,a,o,s){var u=t.sub(e,n).neg(),c=r.sub(e,i),l=s>1?s:s*Math.min(u.mag(),c.mag());a.set().add(u,c).norm().mul(l),o.copyFrom(a).neg(),a.add(a,e),o.add(o,e)};return a.addSegment=function(e){var o;if(void 0!==e.x)o=e;else{var s=arguments,u=s.length;2==u?o=new SQR.V2(s[0],s[1]):3==u&&(o=new SQR.V3(s[0],s[1],s[2]))}return n.push(o),i.push(o.clone(),o.clone()),t||(t=n[0].clone(),r=n[0].clone()),a},a.create=function(t,r){if(n.length<2)return n;t=null!==t?t:.5,e.length=0;for(var s=n,u=i,c=n.length,l=0;l<c;l++){var f=s[l],h=u[2*l].set(),d=u[2*l+1].set(),v=0==l?s[c-1]:s[l-1],m=l==c-1?s[0]:s[l+1];o(f,v,m,h,d,t),u.push(h,d)}for(var l=0;l<c-1;l++){var v=s[l],m=l==c-1?s[0]:s[l+1],h=0!=l||r?u[2*l+1]:v,d=l!=c-2||r?u[2*l+2]:m,p=new SQR.Bezier(v,h,d,m);e.push(p)}if(r){var p=new SQR.Bezier(s[c-1],u[2*(c-1)+1],u[0],s[0]);e.push(p)}return a.smoothness=t,a.close=a.close,a},a.valueAt=function(t,r){1==t&&(t=.999999),t%=1;var n=t*e.length;return e[0|n].valueAt(n%1,r)},a.bezierAt=function(t){1==t&&(t=.999999),t%=1;var r=t*e.length;return e[0|r]},a.velocityAt=function(t,r){1==t&&(t=.999999),t%=1;var n=t*e.length;return e[0|n].velocityAt(n%1,r)},a.matrixAt=function(t,r){0==t&&(t=SQR.EPSILON),1==t&&(t=1-SQR.EPSILON),t%=1;var n=t*e.length;return e[0|n].matrixAt(n%1,r)},Object.defineProperty(a,"segments",{get:function(){return n}}),Object.defineProperty(a,"paths",{get:function(){return e}}),a},SQR.Triangle=function(t,r,e){this.v0=t,this.v1=r,this.v2=e,this.calculateCentroid=function(){this.centroid=new SQR.V2,this.centroid.x=(this.v0.x+this.v1.x+this.v2.x)/3,this.centroid.y=(this.v0.y+this.v1.y+this.v2.y)/3},this.calculateCircumCircle=function(){var t,r,e=this.v1.x-this.v0.x,n=this.v1.y-this.v0.y,i=this.v2.x-this.v0.x,a=this.v2.y-this.v0.y,o=e*(this.v0.x+this.v1.x)+n*(this.v0.y+this.v1.y),s=i*(this.v0.x+this.v2.x)+a*(this.v0.y+this.v2.y),u=2*(e*(this.v2.y-this.v1.y)-n*(this.v2.x-this.v1.x));if(Math.abs(u)<SQR.EPSILON){var c=Math.min(this.v0.x,this.v1.x,this.v2.x),l=Math.min(this.v0.y,this.v1.y,this.v2.y),f=Math.max(this.v0.x,this.v1.x,this.v2.x),h=Math.max(this.v0.y,this.v1.y,this.v2.y);this.circumCenter=new SQR.V2((c+f)/2,(l+h)/2),t=this.circumCenter.x-c,r=this.circumCenter.y-l}else{var d=(a*o-n*s)/u,v=(e*s-i*o)/u;this.circumCenter=new SQR.V2(d,v),t=this.circumCenter.x-this.v0.x,r=this.circumCenter.y-this.v0.y}this.circumRadiusSq=t*t+r*r,this.circumRadius=Math.sqrt(this.circumRadiusSq)},this.vertexInCircumcircle=function(t){this.circumCenter||this.calculateCircumCircle();var r=this.circumCenter.x-t.x,e=this.circumCenter.y-t.y;return r*r+e*e<=this.circumRadiusSq},this.get=function(t){return 0==t?this.v0:1==t?this.v1:2==t?this.v2:void 0}},SQR.V2=function(t,r){this.set(t,r),this.size=2},SQR.V2.prototype.set=function(t,r){return this.x=t||0,this.y=r||0,this},SQR.V2.prototype.copyTo=function(t){return t.x=this.x,t.y=this.y,t},SQR.V2.prototype.copyFrom=function(t){return t instanceof Array?(this.x=t[0],this.y=t[1]):(this.x=t.x,this.y=t.y),this},SQR.V2.prototype.clone=function(){return new SQR.V2(this.x,this.y)},SQR.V2.prototype.magsq=function(){return this.x*this.x+this.y*this.y},SQR.V2.prototype.mag=function(){return Math.sqrt(this.magsq())},SQR.V2.prototype.isZero=function(){return 0==this.x&&0==this.y},SQR.V2.prototype.mul=function(t){return this.x*=t,this.y*=t,this},SQR.V2.prototype.neg=function(){return this.x=-this.x,this.y=-this.y,this},SQR.V2.prototype.norm=function(){var t=1/this.mag();return this.set(this.x*t,this.y*t),this},SQR.V2.prototype.add=function(t,r){return r=r||this,this.x=t.x+r.x,this.y=t.y+r.y,this},SQR.V2.prototype.sub=function(t,r){return r=r||this,this.x=t.x-r.x,this.y=t.y-r.y,this},SQR.V2.prototype.lerp=function(t,r,e){return this.x=t.x+(r.x-t.x)*e,this.y=t.y+(r.y-t.y)*e,this},SQR.V2.dot=function(t,r){return t.x*r.x+t.y*r.y},SQR.V2.prototype.perp=function(){return this.set(this.y,-this.x),this},SQR.V2.prototype.toUniform=function(){return this.toArray()},SQR.V2.prototype.toArray=function(){return this.array||(this.array=new Float32Array(2)),this.array[0]=this.x,this.array[1]=this.y,this.array},SQR.V3=function(t,r,e){this.set(t,r,e),this.size=3,SQR.V3.instances++},SQR.V3.prototype.set=function(t,r,e,n){return this.x=t||0,this.y=r||0,this.z=e||0,this.w=n||1,this},SQR.V3.prototype.copyTo=function(t){return t.x=this.x,t.y=this.y,void 0!=t.z&&(t.z=this.z),t},SQR.V3.prototype.copyFrom=function(t){return t instanceof Array?(this.x=t[0],this.y=t[1],this.z=t[2]||0):(this.x=t.x,this.y=t.y,this.z=t.z||0),this},SQR.V3.prototype.clone=function(){return new SQR.V3(this.x,this.y,this.z)},SQR.V3.prototype.magsq=function(){return this.x*this.x+this.y*this.y+this.z*this.z},SQR.V3.prototype.mag=function(){return Math.sqrt(this.magsq())},SQR.V3.prototype.isZero=function(){return Math.abs(this.x)<SQR.EPSILON&&Math.abs(this.y)<SQR.EPSILON&&Math.abs(this.z)<SQR.EPSILON},SQR.V3.prototype.mul=function(t){return this.x*=t,this.y*=t,this.z*=t,this},SQR.V3.prototype.neg=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},SQR.V3.prototype.norm=function(){var t=1/this.mag();return this.set(this.x*t,this.y*t,this.z*t),this},SQR.V3.prototype.add=function(t,r){return r=r||this,this.x=t.x+r.x,this.y=t.y+r.y,this.z=t.z+r.z,this},SQR.V3.prototype.sub=function(t,r){return this.x=t.x-r.x,this.y=t.y-r.y,this.z=t.z-r.z,this},SQR.V3.prototype.lerp=function(t,r,e){return this.x=t.x+(r.x-t.x)*e,this.y=t.y+(r.y-t.y)*e,this.z=t.z+(r.z-t.z)*e,this},SQR.V3.prototype.random=function(){return this.x=2*Math.random()-1,this.y=2*Math.random()-1,this.z=2*Math.random()-1,this},SQR.V3.dot=function(t,r){return t.x*r.x+t.y*r.y+t.z*r.z},SQR.V3.prototype.cross=function(t,r){var e=t.y*r.z-t.z*r.y,n=t.z*r.x-t.x*r.z,i=t.x*r.y-t.y*r.x;return this.set(e,n,i,this.w),this},SQR.V3.prototype.toUniform=function(){return this.toArray()},SQR.V3.prototype.toArray=function(){return this.array||(this.array=new Float32Array(3)),this.array[0]=this.x,this.array[1]=this.y,this.array[2]=this.z,this.array},SQR.V3.prototype.toString=function(){return x},SQR.V3.prototype.toScreenSpace=function(t,r){t=t||window.innerWidth,r=r||window.innerHeight,this.x=this.x/this.z*t/2+t/2,this.y=this.y/this.z*r/2+r/2,this.y=r-this.y},SQR.V3.prototype.addNormal=function(t){this.normal||(this.normal=new SQR.V3),this.normal.add(this.normal,t)},SQR.V3.prototype.resetNormal=function(t){this.normal&&this.normal.set()},SQR.V3.up=new SQR.V3(0,1,0),SQR.V3.forward=new SQR.V3(0,0,1),SQR.V3.__tv1=new SQR.V3,SQR.V3.__tv2=new SQR.V3,SQR.V3.__tv3=new SQR.V3,SQR.V3.instances=0,SQR.CanvasRenderer=function(t){var r={},e=null;if(t||(t=document.createElement("canvas")),t instanceof HTMLElement||(t=document.querySelector(t)),!t.getContext)throw"> SQR.Context - Invalid canvas reference.";var n=t.getContext("2d");return n.setLineDash||(n.setLineDash=function(){}),r.canvas=t,r.context=n,r.setSize=function(r,e,n){return n=n||1,t.width=r*n,t.height=e*n,t.style.width=r+"px",t.style.height=e+"px",n},r.setClearColor=function(t){return e=t,r},r.render=function(r){e?(e.indexOf("rgba")>-1&&n.clearRect(0,0,t.width,t.height),n.fillStyle=e,n.fillRect(0,0,t.width,t.height)):n.clearRect(0,0,t.width,t.height),r&&r.draw(n)},r},SQR.Transform2d=function(t){var r={};return r.name=t||"sqr.transform."+SQR.Transform2dCount++,r.position=new SQR.V3(0,0,0),r.rotation=0,r.scale=new SQR.V2(1,1),r.alpha=1,r.children=[],r.numChildren=0,
r.add=function(){for(var t=0;t<arguments.length;t++){var e=arguments[t];e.parent=r,-1==r.children.indexOf(e)&&r.children.push(e)}return r.numChildren=r.children.length,r},r.remove=function(){for(var t=0;t<arguments.length;t++){var e=arguments[t],n=r.children.indexOf(e);if(-1==n)return!1;e.parent=null,r.children.splice(n,1)}return r.numChildren=r.children.length,r},r.removeAll=function(){r.children.length=0,r.numChildren=0},r.contains=function(t){return r.children.indexOf(t)>-1},r.recurse=function(t,e){e||t(r);for(var n=0;n<r.numChildren;n++)r.children[n].recurse(t)},r.draw=function(t){var e=t;e.save(),e.translate(r.position.x,r.position.y),e.rotate(r.rotation),e.scale(r.scale.x,r.scale.y);for(var n=0;n<r.numChildren;n++)r.children[n].draw(e);r.alpha<1&&(e.globalAlpha=r.alpha),r.shape&&r.shape(e,r),e.restore()},r},SQR.Transform2dCount=0,SQR.Primitives.createCube=function(t,r,e,n){t=t||1,r=r||1,e=e||1,n=n||{};var i=new SQR.Mesh,a=i.V(-.5*t,.5*r,.5*e),o=i.V(.5*t,.5*r,.5*e),s=i.V(-.5*t,-.5*r,.5*e),u=i.V(.5*t,-.5*r,.5*e),c=i.V(-.5*t,.5*r,-.5*e),l=i.V(.5*t,.5*r,-.5*e),f=i.V(-.5*t,-.5*r,-.5*e),h=i.V(.5*t,-.5*r,-.5*e),d=i.T(0,1),v=i.T(1,1),m=i.T(0,0),p=i.T(1,0);return i.F(a,o,s,u).T(d,v,m,p),i.F(l,c,h,f).T(d,v,m,p),i.F(c,a,f,s).T(d,v,m,p),i.F(o,l,u,h).T(d,v,m,p),i.F(c,l,a,o).T(d,v,m,p),i.F(s,u,f,h).T(d,v,m,p),i.calculateNormals(n.smooth),n.flip&&i.flip(),i.update()},SQR.Primitives.createCylinder=function(t,r,e,n){n=n||{};var i,a,o,s,u,c,l=[],f=function(t,r,e,n,i,a,o,s){var u=(new SQR.Face).setPosition(t,r,e,n).setUV(i,a,o,s);l.push(u)};i=[],a=[],o=[],s=[];for(var h=0;h<e;h++){var d=new SQR.V3,v=new SQR.V3,m=new SQR.V2,p=new SQR.V2,R=Math.cos(h/e*SQR.TWOPI)*r,S=Math.sin(h/e*SQR.TWOPI)*r;n.vertical?(d.set(S,-.5*t,R),v.set(S,.5*t,R)):(d.set(-.5*t,R,S),v.set(.5*t,R,S)),m.set(h/e,0),p.set(h/e,1),n.noCaps||(n.vertical?(u=new SQR.V3(0,-.5*t,0),c=new SQR.V3(0,.5*t,0)):(u=new SQR.V3(-.5*t,0,0),c=new SQR.V3(.5*t,0,0))),i.push(d),a.push(v),o.push(m),s.push(p),n.insideFaces&&(d._inside=d.clone(),v._inside=v.clone())}for(var h=0;h<e;h++){var y=i[h],x=a[h],Q=o[h],g=s[h],E=(h+1)%e,T=i[E],_=a[E],M=o[E],b=s[E];if(n.heightSegments=n.heightSegments||n.hs||0,n.heightSegments)for(var w=(new SQR.V3).sub(x,y),A=(new SQR.V3).sub(_,T),V=(new SQR.V3).copyFrom(y),P=(new SQR.V3).copyFrom(T),U=new SQR.V3,F=new SQR.V3,E=n.heightSegments,z=0;z<E+1;z++)U.copyFrom(w).mul(1/E*z).add(y,U),F.copyFrom(A).mul(1/E*z).add(T,F),f(V.clone(),U.clone(),P.clone(),F.clone(),Q,g,M,b),V.copyFrom(U),P.copyFrom(F);else f(y,x,T,_,Q,g,M,b),n.noCaps&&n.insideFaces&&f(y._inside,T._inside,x._inside,_._inside,Q,g,M,b);n.noCaps||(f(y,T,u,null,g,b,M),f(_,x,c,null,b,g,M))}var d,C=n.layout||{aPosition:3,aNormal:3,aUV:2},I=SQR.Buffer().layout(C,6*l.length),B=0;return l.forEach(function(t){B+=t.calculateNormal().toBuffer(I,B)}),I},SQR.Extrude=function(){var t={};t.buffer=SQR.Buffer();var r,e,n,i,a,o,s,u=[],c=[];t.setPaths=function(a,o,s,u){return r=a,e=a.length,n=o,i=s||10,l(u),t},t.makeCaps=function(){return t};var l=function(r){u.length=0,c.length=0,r=r||SQR.v3n3();for(var n=0;n<i;n++)for(var a=0;a<e;a++){var o=new SQR.V3;u.push(o)}for(var n=0;n<i-1;n++)for(var a=0;a<e;a++){var s=n*e+a,l=a<e-1?s+1:n*e,f=(n+1)*e+a,h=a<e-1?f+1:(n+1)*e,d=(new SQR.Face).setPosition(u[s],u[h],u[l]),v=(new SQR.Face).setPosition(u[s],u[f],u[h]);c.push(d,v)}t.buffer.layout(r,3*c.length)},f=function(s,l){for(var f=0;f<i;f++)for(var h=f/(i-1),d=o+h*a,v=n.matrixAt(d),m=0;m<e;m++){var p=u[f*e+m];p.copyFrom(r[m]),s&&s(h,p,t),v.transformVector(p),l&&l(h,p,t)}for(var R=0,f=0,S=c.length;f<S;f++)R+=c[f].calculateNormal().toBuffer(t.buffer,R,!1,!0)};return t.update=function(r,e,n,i){return o=r||0,s=e||1,a=s-o,f(n,i),t.buffer.update(),t},t},SQR.Face=function(){if(!(this instanceof SQR.Face))return new SQR.Face},SQR.Face.prototype.setPosition=function(t,r,e,n){var i=this;return i.a=t||new SQR.V3,i.b=r||new SQR.V3,i.c=e||new SQR.V3,i.d=n,i},SQR.Face.prototype.setIndex=function(t,r,e,n,i){var a=this;return a.indexed=!0,a.ia=r,a.ib=e,a.ic=n,a.id=i,a.vertexArray=t,a},SQR.Face.prototype.flip=function(){var t=this,r=t.b;t.b=t.c,t.c=r},SQR.Face.prototype.setNormal=function(t){return this.normal=t,this},SQR.Face.prototype.setUV=function(t,r,e,n){var i=this;return i.uva=t,i.uvb=r,i.uvc=e,i.uvd=n,i},SQR.Face.prototype.setColor=function(t,r,e,n){var i=this;return i.ca=t,i.cb=r,i.cc=e,i.cd=n,i},SQR.Face.prototype.calculateNormal=function(){var t=this,r=SQR.V3.__tv1,e=SQR.V3.__tv2,n=t.vertexArray;return t.normal=t.normal||new SQR.V3,t.indexed?(r.sub(n[t.ia],n[t.ib]),r.isZero()&&r.sub(n[t.ia],n[t.id]),e.sub(n[t.ic],n[t.ia])):(r.sub(t.a,t.b),r.isZero()&&r.sub(t.a,t.d),e.sub(t.c,t.a)),t.normal.cross(r,e),t},SQR.Face.prototype.v=SQR.Face.prototype.setPosition,SQR.Face.prototype.i=SQR.Face.prototype.setIndex,SQR.Face.prototype.n=SQR.Face.prototype.setNormal,SQR.Face.prototype.uv=SQR.Face.prototype.setUV,SQR.Face.prototype.cl=SQR.Face.prototype.setColor,SQR.Face.prototype.cn=SQR.Face.prototype.calculateNormal,SQR.Face.prototype.addNormalToVertices=function(){var t=this,r=t.vertexArray,e=t.indexed?r[t.ia]:t.a,n=t.indexed?r[t.ib]:t.b,i=t.indexed?r[t.ic]:t.c,a=t.indexed?r[t.id]:t.d;return e.addNormal(t.normal),n.addNormal(t.normal),i.addNormal(t.normal),a&&a.addNormal(t.normal),t},SQR.Face.prototype.toBuffer=function(t,r,e,n){var i=this,a="aPosition",o="aNormal",s="aUV",u=r;if(t.attributes[a]&&(t.set(a,u+0,i.a).set(a,u+1,i.b).set(a,u+2,i.c),i.d&&t.set(a,u+3,i.c).set(a,u+4,i.b).set(a,u+5,i.d)),t.attributes[o]&&(i.normal||e)){var c=e,l=i.normal;n&&!c&&i.normal.norm(),t.set(o,u+0,c?i.a.normal:l).set(o,u+1,c?i.b.normal:l).set(o,u+2,c?i.c.normal:l),i.d&&t.set(o,u+3,c?i.c.normal:l).set(o,u+4,c?i.b.normal:l).set(o,u+5,c?i.d.normal:l)}return t.attributes[s]&&i.uva&&(t.set(s,u+0,i.uva).set(s,u+1,i.uvb).set(s,u+2,i.uvc),i.d&&t.set(s,u+3,i.uvc).set(s,u+4,i.uvb).set(s,u+5,i.uvd)),i.d?6:3},SQR.Primitives.createIcosphere=function(t,r,e){var n=[],i=[],a=[],o=0;e=e||{};var s=[[1,0,0,1],[0,1,0,2],[0,0,1,3],[1,1,0,4],[0,1,1,5]],u=new SQR.V3,c=(new SQR.V3(0,1,0),new SQR.V3(0,0,1),function(t){var r,e;return u.copyFrom(t),u.norm(),r=1-(.5+Math.atan2(u.z,u.x)/SQR.TWOPI),e=1-(.5-Math.asin(u.y)/Math.PI),new SQR.V2(r,e)}),l=function(t,r,e,i,a,o){var s=c(t),u=c(r),l=c(e),f=(new SQR.Face).setPosition(t,r,e).setUV(s,u,l).setColor(i,a,o);n.push(f)},f=function(r,e){for(var n=i.length,a=0;a<n;a++){var o=i[a],s=o.__v1==r&&o.__v2==e,u=o.__v2==r&&o.__v1==e;if(s||u)return o}var c=new SQR.V3;return c.sub(r,e).mul(.5).add(c,e).norm().mul(t),c.__v1=r,c.__v2=e,i.push(c),c.normal=c.clone(),c},h=t,d=.5*(1+Math.sqrt(5))*h,v=function(r,n,a){var o=new SQR.V3(r,n,a).norm();o.normal=o.clone(),e.reverseNormals&&o.normal.neg(),o.mul(t),i.push(o)},m=function(t,r,e){var n=s[0];l(i[t],i[e],i[r],n,n,n)};for(v(-h,d,0),v(h,d,0),v(-h,-d,0),v(h,-d,0),v(0,-h,d),v(0,h,d),v(0,-h,-d),v(0,h,-d),v(d,0,-h),v(d,0,h),v(-d,0,-h),v(-d,0,h),m(0,11,5),m(0,5,1),m(0,1,7),m(0,7,10),m(0,10,11),m(1,5,9),m(5,11,4),m(11,10,2),m(10,7,6),m(7,1,8),m(3,9,4),m(3,4,2),m(3,2,6),m(3,6,8),m(3,8,9),m(4,9,5),m(2,4,11),m(6,2,10),m(8,6,7),m(9,8,1);r-- >0;)!function(){a[o]={};var t=a[o];t.faces=n,t.vectors=i,n=[];for(var r=t.faces.length,e=0;e<r;e++){var u=t.faces[e],c=f(u.a,u.b),h=f(u.a,u.c),d=f(u.b,u.c),v=s[o+1];l(u.a,c,h,u.ca,v,v),l(u.b,d,c,u.cb,v,v),l(u.c,h,d,u.cc,v,v),l(c,d,h,v,v,v)}o++}();var d,p=SQR.Buffer().layout({aPosition:3,aNormal:3,aUV:2},3*n.length),R=0;return n.forEach(function(t){e.flatShading&&t.calculateNormal(),R+=t.toBuffer(p,R,!e.flatShading)}),p},SQR.Mesh=function(){if(!(this instanceof SQR.Mesh))return new SQR.Mesh;var t=this;t.polys=[],t.vertices=[],t.uvs=[],t.size=0,t.addVertex=function(r,e,n){var i=new SQR.Vertex(r,e,n);return t.vertices.push(i),t.vertices.length-1},t.addUV=function(r,e){var e=new SQR.V2(r,e);return t.uvs.push(e),t.uvs.length-1},t.addFace=function(){var r=new SQR.Poly(t);return r.V.apply(r,arguments),t.polys.push(r),t.size+=r.triangles.length,r},t.calculateNormals=function(r){t.smooth=r;for(var e=0,n=t.polys.length;e<n;e++)t.polys[e].calculateNormal();if(t.smooth)for(var e=0,n=t.vertices.length;e<n;e++)t.vertices[e].polys&&t.vertices[e].calculateNormal();return t},t.flip=function(){for(var r=0,e=t.polys.length;r<e;r++)t.polys[r].flip();return t},t.calculateTangents=function(){console.log("SQR.Mesh.calculateTangents is not implemented yet!")};var r=function(){var r=t.polys[0],e=t.size,n={aPosition:3};return r.normal&&(n.aNormal=3),r.uvs.length>0&&(n.aUV=2),t.buffer=SQR.Buffer().layout(n,e),t.buffer};t.update=function(){if(0==t.polys.length)return void console.warn("> SQR.Mesh.update > no polys found to create buffer from.");for(var e=t.buffer||r(),n=e.attributes.aPosition,i=0,a=[],o=0,s=t.polys.length;o<s;o++)for(var u=t.polys[o],c=0,l=u.triangles.length;c<l;c++){var f=u.triangles[c],h=t.vertices[u.vertices[f]],n=h.position,d=t.smooth?h.normal:u.normal,v=t.uvs[u.uvs[f]];a.length=0,a.push(n.x,n.y,n.z,d.x,d.y,d.z,v.x,v.y),e.set(null,i,a),i++}return e.update(),e.mesh||(e.mesh=t),e},t.V=t.addVertex,t.F=t.addFace,t.T=t.addUV},SQR.Mesh.fromJSON=function(t,r,e){var n;if(e=e||{},r)n=t[r];else if(t.vertices)n=t;else for(var i in t){n=t[i];break}if(!n)throw"> SQR.Mesh - mesh not found in data (name: "+r+")";var a={aPosition:"vertices",aNormal:"normals",aColor:"colors",aUV:"uv1",aUV2:"uv2",aTangent:"tangent",aWeight:"boneWeights",aIndex:"boneIndices",indices:"tris"},o=function(t){var r=n[t]||n[a[t]];return r&&r.length>0?r:0==r.length&&"aUV2"==t?o("aUV"):null},s=e.layout||t.layout||SQR.v3n3u2(),u=e.vertexSize||s.aPosition,c=(n.vertices||n.aPosition).length/u,l=SQR.Buffer().layout(s,c);for(var f in s){var i=o(f);i&&l.data(f,i)}var h=o("indices");return h&&l.index(h),l.update()},SQR.Primitives.createPlane=function(t,r,e,n,i,a,o){var s,u,o=o||{},t=.5*t,r=.5*r,i=i||0,a=a||0,e=e||1,n=n||1,c=-t+i,l=-r+a,f=2*t/e,h=2*r/n,d=new SQR.Mesh;for(s=0;s<e+1;s++)for(u=0;u<n+1;u++){var v=c+s*f,m=l+u*h;o.zUp?d.V(v,m,0):d.V(v,0,m),d.T(s/e,u/n)}for(s=0;s<e;s++)for(u=0;u<n;u++){var v=c+s*f,m=l+u*h,p=(s+0)*(n+1)+u,R=(s+1)*(n+1)+u;d.F(p,p+1,R,R+1).T(p,p+1,R,R+1)}return d.calculateNormals(o.smooth),o.flip&&d.flip(),d.update()},SQR.Poly=function(t){var r=this;r.mesh=t,r.triangles=[]},SQR.Poly.prototype.addVertices=function(){var t=this;if(t.size=arguments.length,t.size<3)throw"> SQR.Poly.addVertices > A poly needs at least 3 vertices.";t.vertices=[];for(var r=0;r<t.size;r++){var e=arguments[r];t.mesh.vertices[e].addPoly(t),t.vertices.push(e)}return t.size>=3&&t.triangles.push(0,1,2),t.size>=4&&t.triangles.push(2,1,3),t},SQR.Poly.prototype.addUV=function(t,r,e,n){var i=this;return i.uvs=[t,r,e],n&&i.uvs.push(n),i},SQR.Poly.prototype.flip=function(){var t=this,r=this.vertices,e=this.uvs,n=r[1];r[1]=r[2],r[2]=n,e&&(n=e[1],e[1]=e[2],e[2]=n),r.normal?r.normal.neg():t.normal?t.normal.neg():console.log("> SQR.Poly.flip > please consider calculating normal first, then flipping")},SQR.Poly.prototype.calculateNormal=function(){var t=this,r=this.vertices,e=t.mesh.vertices,n=SQR.V3.__tv1,i=SQR.V3.__tv2;return t.normal=t.normal||new SQR.V3,n.sub(e[r[0]].position,e[r[1]].position),n.isZero()&&t.size>3&&n.sub(e[r[0]].position,e[r[3]].position),i.sub(e[r[2]].position,e[r[0]].position),t.normal.cross(n,i).norm(),t},SQR.Poly.prototype.V=SQR.Poly.prototype.addVertices,SQR.Poly.prototype.T=SQR.Poly.prototype.addUV,SQR.Primitives.createPostEffect=function(t,r,e){e=e||SQR.Buffer().layout(SQR.v2u2(),6).data("aPosition",-1,1,1,1,1,-1,-1,1,1,-1,-1,-1).data("aUV",0,1,1,1,1,0,0,1,1,0,0,0).update();var n=new SQR.Transform("post-effect");return n.buffer=e,t&&(n.shader=SQR.Shader(t,r)),n},SQR.SceneParser=function(){var t=function(t,r){r.x=t[0],r.y=t[1],r.z=t[2],r.w&&(r.w=t[3])};return{parse:function(r,e){e=e||{};var n=e.prefix||"",i=r[n+"scene"],a=r[n+"mesh"],o=r[n+"anim"];if(e.context){var s=i.background;e.context.clearColor(s.r,s.g,s.b)}var u=function(){var t;return function(){return t||(t=e.shader.setUniform?e.shader:SQR.Shader(e.shader)),t}}();SQR.flipMatrix=!(!e||!e.flipMatrix)&&e.flipMatrix;var c={},l={},f=[],h={};for(var d in a){var v=a[d],m=SQR.v3n3u2();v.boneWeights&&(m.aWeight=4,m.aIndex=4),v.uv2&&(m.aUV2=2);var p=SQR.Mesh.fromJSON(v,null,{layout:m});c[d]=p,l[v.name]=p}for(var R in i.materials){var S=i.materials[R];S.color=SQR.Color().setRGB(S.color.r,S.color.g,S.color.b)}var y,x=new SQR.Transform;i.transforms.forEach(function(r){var e=new SQR.Transform(r.name,r.uid);if(e.useQuaternion=!0,t(r.position,e.position),t(r.rotation,e.quaternion),r.scale&&t(r.scale,e.scale),e.data=r,r.bones&&f.push(e),r.camera){y=e;var n=i.cameras[r.camera],a=window.innerWidth,o=window.innerHeight,s=a/o;y.projection=(new SQR.ProjectionMatrix).perspective(n.fov,s,n.near,n.far)}if(r.lightmapTileOffset&&(e.uniforms=e.uniforms||{},e.uniforms.uLightmapTileOffset=r.lightmapTileOffset),r.mesh&&(e.buffer=c[r.meshId]),r.collider){var l;switch(r.collider.type){case"sphere":l=SQR.Collider.Sphere(),l.radius=r.collider.radius,t(r.collider.center,l.center);break;case"box":l=SQR.Collider.Box();var h=r.collider.center,d=r.collider.size;l.box={maxX:h[0]+d[0]/2,minX:h[0]-d[0]/2,maxY:h[1]+d[1]/2,minY:h[1]-d[1]/2,maxZ:h[2]+d[2]/2,minZ:h[2]-d[2]/2};break;case"mesh":l=SQR.Collider.Mesh(c[r.meshId])}e.collider=l}r.renderer&&(r.bones||(e.shader=u()),e.uniforms=e.uniforms||{},e.uniforms.uColor=i.materials[r.renderer].color),r.parent?x.findById(r.parent).add(e):x.add(e)}),f.forEach(function(t){var r=t.data.bones,n=[],i=r.length;r.forEach(function(t){n.push(x.findById(t))}),n[0].setAsBoneRoot();var a=[];t.shader=SQR.Shader(e.shader,{directives:[{name:"NUM_BONES",value:i},{name:"BONE_PER_VERTEX",value:4}]}),t.beforeDraw=function(){for(var r=0;r<i;r++)a[r]=n[r].computeBoneMatrix();t.shader.use().setUniform("uBones",a)}});for(var Q in o){var g=o[Q];h[Q]={duration:g.length,transforms:{}};for(var E in g.curves){h[Q].transforms[E]={properties:{}};for(var T in g.curves[E]){var _=[],M=g.curves[E][T];if(e.linearAnimation)for(var b=0;b<M.keys.length;b+=4){var w=M.keys[b+0],p=M.keys[b+1];_.push(new SQR.V2(w,p))}else for(var b=0;b<M.keys.length-4;b+=4){var A=M.keys[b+0],V=M.keys[b+1],P=M.keys[b+3],U=M.keys[b+4],F=M.keys[b+5],z=M.keys[b+6],C=new SQR.V2(A,V),I=new SQR.V2(U,F),B=(I.x-C.x)/3,N=new SQR.V2(B,B*P).add(C),L=new SQR.V2(-B,-B*z).add(I);_.push(new SQR.Bezier(C,N,L,I))}h[Q].transforms[E].properties[T]=_}}}return x.recurse(function(t){if(t.data&&t.data.animationId){var r=t.data.animationId,n=h[r];if(!n)return;t.animation=SQR.Animation(n.duration);for(var i in n.transforms){var a=t.findByPath(i);a.clip=SQR.Clip(n.duration),t.animation.addClip(a.clip);for(var o in n.transforms[i].properties)a.clip.addProperty(o,n.transforms[i].properties[o])}e.autoPlay&&t.animation.play()}},!0),{root:x,camera:y,buffers:l}}}}(),SQR.Primitives.createSphere=function(t,r,e,n){var i=new SQR.Mesh;t=t||50,r=Math.max(3,Math.floor(r)||8),e=Math.max(3,Math.floor(e)||6),n=n||{};var a,o,s=2*Math.PI,u=Math.PI;for(o=0;o<=e;o++)for(a=0;a<r;a++){var c=a/(r-1),l=o/e,f=-t*Math.cos(c*s)*Math.sin(l*u),h=t*Math.cos(l*u),d=t*Math.sin(c*s)*Math.sin(l*u);i.V(f,h,d);i.T(c,1-l)}for(o=0;o<e;o++){var v=0==o,m=o==e-1;for(a=0;a<r;a++){var p=o,R=o+1,S=a,y=(a+1)%r,x=p*r+S,Q=p*r+y,g=R*r+S,E=R*r+y;v?i.F(x,E,g).T(x,E,g):m?i.F(x,Q,E).T(x,Q,E):i.F(x,Q,g,E).T(x,Q,g,E)}}return i.calculateNormals(n.smooth),n.flip&&i.flip(),i.update()},SQR.Vertex=function(t,r,e){var n=this;n.position=new SQR.V3(t,r,e),n.normal=new SQR.V3},SQR.Vertex.prototype.addPoly=function(t){var r=this;r.polys=r.polys||[],r.polys.push(t)},SQR.Vertex.prototype.calculateNormal=function(){var t=this;t.normal.set();for(var r=0,e=t.polys.length;r<e;r++)t.normal.add(t.polys[r].normal);t.normal.norm()};