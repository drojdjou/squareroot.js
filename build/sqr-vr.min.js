SQR.Gyro=function(){var e={x:0,y:0,z:0,w:1},t={},n=!1,r=!1;t.getOrientation=function(){return r||u(),e},t.hasGyro=function(){return n};var o=function(e,t,n){var r=-t,o=-e;z=n;var i=Math.cos(r/2),a=Math.cos(o/2),s=Math.cos(z/2),c=Math.sin(r/2),u=Math.sin(o/2),d=Math.sin(z/2),l=i*a*s-c*u*d;return r=c*a*s-i*u*d,o=i*u*s+c*a*d,z=i*a*d+c*u*s,{x:r,y:o,z:z,w:l}},i=function(e,t){return{w:e.w*t.w-e.x*t.x-e.y*t.y-e.z*t.z,x:e.w*t.x+e.x*t.w+e.y*t.z-e.z*t.y,y:e.w*t.y-e.x*t.z+e.y*t.w+e.z*t.x,z:e.w*t.z+e.x*t.y-e.y*t.x+e.z*t.w}},a=.5*Math.PI,s={x:Math.sin(.5*a),y:0,z:0,w:Math.cos(.5*a)},c=function(t){if(null!=t.alpha&&null!=window.orientation){n=!0;var r=o(t.alpha/180*Math.PI,t.beta/180*Math.PI,t.gamma/180*Math.PI),a=window.orientation/180*Math.PI,c={x:0,y:0,z:Math.sin(.5*a),w:Math.cos(.5*a)};e=r,e=i(s,e),e=i(c,e)}},u=function(){window.addEventListener("deviceorientation",c,!0),r=!0};return t}(),SQR.VRApp=function(e,t){t=t||{},t.isTouch="ontouchstart"in document,t.vrInput=null,t.vrData={};var n,r,o,i={},a="<span>Put on your headset and press space when ready.</span>",s=function(e){e.requestFullscreen?e.requestFullscreen(i):e.msRequestFullscreen?e.msRequestFullscreen(i):e.mozRequestFullScreen?e.mozRequestFullScreen(i):e.webkitRequestFullscreen&&e.webkitRequestFullscreen(i)},c=function(e){32==e.keyCode&&(document.removeEventListener("keydown",c),u())},u=function(i){n&&document.body.removeChild(n),r&&document.body.removeChild(r),o&&document.body.removeChild(o),(t.isTouch||t.vrInput&&!t.debug)&&s(document.body),e&&e(t)},d=function(){t.vrInput&&!t.isTouch?(o=document.createElement("div"),o.innerHTML=a+a,o.setAttribute("class","instr"),document.body.appendChild(o),document.addEventListener("keydown",c)):t.isTouch?(n=document.createElement("div"),n.setAttribute("class","start vr"),n.innerHTML="CARDBOARD",document.body.appendChild(n),r=document.createElement("div"),r.setAttribute("class","start novr"),r.innerHTML="NO CARDBOARD",document.body.appendChild(r),portWarn=document.createElement("div"),portWarn.setAttribute("class","portrait-warning"),portWarn.innerHTML="Please rotate your screen to landscape mode",document.body.appendChild(portWarn),n.addEventListener("click",function(){t.forceStereo=!0,u()}),r.addEventListener("click",function(){t.forceMono=!0,u()})):u()};!function(e){var n,r=function(t){console.log("VR: Error in navigator.getVRDevices()"),console.log(t),e()},o=function(r){SQR.flipMatrix=!1;for(var o=0;o<r.length;o++){var a=r[o];!t.vrInput&&a instanceof PositionSensorVRDevice&&(t.vrInput=a),!n&&a instanceof HMDVRDevice&&(n=a),i.vrDisplay=n}t.vrData.leftEyeX=n.getEyeParameters("left").eyeTranslation.x,t.vrData.rightEyeX=n.getEyeParameters("right").eyeTranslation.x,t.vrData.leftEyeFOV=n.getEyeParameters("left").recommendedFieldOfView,t.vrData.rightEyeFOV=n.getEyeParameters("right").recommendedFieldOfView,e()};if(!navigator.mozGetVRDevices&&!navigator.getVRDevices)return console.log("VR: Your browser is not VR Ready"),void e();navigator.getVRDevices?navigator.getVRDevices().then(o,r):navigator.mozGetVRDevices(o)}(d)},SQR.VRPost=function(e,t,n,r){var o,i,a,s,c,u=r.vrInput&&!r.forceMono||r.forceStereo,d=!0,l=new SQR.Transform,v=new SQR.Transform;return l.position.x=r.vrData.leftEyeX||-.1,v.position.x=r.vrData.rightEyeX||.1,(r.isTouch||r.vrInput)&&(e.useQuaternion=!0),e.add(l,v),t.autoClear=!1,r.customShader&&(s=SQR.FrameBuffer(0,0),c=SQR.Primitives.createPostEffect(r.customShader),c.uniforms={scale:new SQR.V2(.81,.81),scaleIn:new SQR.V2(1,1),lensCenter:new SQR.V2(0,0),hmdWarpParam:[1,.11,.12,0],chromAbParam:[.996,-.004,1.014,0]}),{size:function(){var t=window.devicePixelRatio;o=window.innerWidth*t,i=window.innerHeight*t,a=o/2,n.size(window.innerWidth,window.innerHeight,t),r.customShader&&s.resize(a,i);var c=o/i,d=.5*o/i,m=u?80:50;r.vrData&&r.vrData.leftEyeFOV&&(m=2*r.vrData.leftEyeFOV.leftDegrees);var h=(new SQR.ProjectionMatrix).perspective(m,u?d:c,r.near||.1,r.far||1e4);e.projection=h,l.projection=h,v.projection=h},render:function(m){if(r.vrInput){var h=r.vrInput.getState();null!==h.orientation&&e.quaternion.copyFrom(h.orientation),null!==h.position&&e.position.copyFrom(h.position)}else r.isTouch&&SQR.Gyro.hasGyro()?e.quaternion.copyFrom(SQR.Gyro.getOrientation()):r.customCameraAnimation&&r.customCameraAnimation();if(n.viewport(0,0,o,i),n.clear(),u?r.customShader?(s.bind(),n.clear(),t.render(m,l),t.renderToScreen(),n.viewport(0,0,a,i),c.shader.use().setUniform("uTexture",s.texture),t.render(c),s.bind(),n.clear(),t.render(m,v),t.renderToScreen(),n.viewport(a,0,a,i),c.shader.use().setUniform("uTexture",s.texture),t.render(c)):(n.viewport(0,0,a,i),t.render(m,l),n.viewport(a,0,a,i),t.render(m,v)):t.render(m,e),d){if(r.target&&r.camRoot){var p=(new SQR.V3).sub(r.camRoot.position,r.target.position),y=(new SQR.V3).copyFrom(e.forward);p.y=0,y.y=0,p.norm(),y.norm();var f=SQR.V3.dot(p,y);Math.acos(f),Math.PI;r.camRoot.rotation.y=-Math.acos(f)}d=!1}}}};